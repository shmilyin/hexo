{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"themes/yilia/source/css/style.styl","path":"css/style.styl","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/coderwall.png","path":"img/coderwall.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/delicious.png","path":"img/delicious.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/douban.png","path":"img/douban.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/github.png","path":"img/github.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/facebook.png","path":"img/facebook.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/img-loading.png","path":"img/img-loading.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/google.png","path":"img/google.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/img-err.png","path":"img/img-err.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/linkedin.png","path":"img/linkedin.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/mail.png","path":"img/mail.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/pinboard.png","path":"img/pinboard.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/scrollbar_arrow.png","path":"img/scrollbar_arrow.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/rss.png","path":"img/rss.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/pinterest.png","path":"img/pinterest.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/twitter.png","path":"img/twitter.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/stackoverflow.png","path":"img/stackoverflow.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/weibo.png","path":"img/weibo.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/img/zhihu.png","path":"img/zhihu.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/js/instagram.js","path":"js/instagram.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/js/jquery.lazyload.js","path":"js/jquery.lazyload.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/js/main.js","path":"js/main.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/js/mobile.js","path":"js/mobile.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/js/pc.js","path":"js/pc.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.css","path":"fancybox/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.js","path":"fancybox/jquery.fancybox.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.pack.js","path":"fancybox/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.eot","path":"css/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.svgz","path":"css/fonts/fontawesome-webfont.svgz","modified":1,"renderable":1},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.ttf","path":"css/fonts/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.woff","path":"css/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/fancybox_buttons.png","path":"fancybox/helpers/fancybox_buttons.png","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-buttons.css","path":"fancybox/helpers/jquery.fancybox-buttons.css","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-buttons.js","path":"fancybox/helpers/jquery.fancybox-buttons.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-thumbs.css","path":"fancybox/helpers/jquery.fancybox-thumbs.css","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-thumbs.js","path":"fancybox/helpers/jquery.fancybox-thumbs.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-media.js","path":"fancybox/helpers/jquery.fancybox-media.js","modified":1,"renderable":1},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.svg","path":"css/fonts/fontawesome-webfont.svg","modified":1,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"e0b22c8da97e51c57815af75a4bb282f6af2abfe","modified":1517801444000},{"_id":"themes/yilia/README.md","hash":"8648a81b3ae08a4accd6b0541533e662511e6400","modified":1517801444000},{"_id":"themes/yilia/.gitignore","hash":"0d5c2fdbdc974f10150baa12e1fc171a34960ed8","modified":1517801444000},{"_id":"themes/yilia/_config.yml","hash":"417173ec94dcb81ed5d19f585075db1faeb78423","modified":1517801444000},{"_id":"themes/yilia/package.json","hash":"0199dfb3d44cf520b67464817d13c44a7766b8d6","modified":1517801444000},{"_id":"source/about/index.md","hash":"cf0ccb495b9ab0335fe2c396889af27850694ee2","modified":1517801444000},{"_id":"source/categories/index.md","hash":"f6b05f97bed3a2acfbe0287536d3902991748c58","modified":1517801444000},{"_id":"source/_posts/PandoraBox_ChinaDNS_Shadowsocks fuck_gfw.md","hash":"13965aa7d8e2cfaec099e346301bea8afc0005d5","modified":1517801444000},{"_id":"source/tags/index.md","hash":"a59df0a497bf9f98fe3e6c8d9e9022e1c5795205","modified":1517801444000},{"_id":"source/_posts/gitlab_update_notes.md","hash":"64a381aebbedc6faf72f279290e468d1a72f8d38","modified":1517801444000},{"_id":"source/_posts/hhvm.md","hash":"eefa048958271437c0360109f208c34ba506d85b","modified":1520560636000},{"_id":"source/_posts/neteasy_music_spider.md","hash":"04c645a338a89918bce8444f0146cd12194b9dfe","modified":1517809894000},{"_id":"themes/yilia/languages/de.yml","hash":"bc80f78f61c3d7af9652e6aa6fc3e4ff39b0c8d3","modified":1517801444000},{"_id":"themes/yilia/languages/default.yml","hash":"f0a7a032b31555c9ec05a711e1ac19bb07724708","modified":1517801444000},{"_id":"themes/yilia/languages/en.yml","hash":"a093e794aef63ec9e9e9ef490cf7e4474e45e59f","modified":1517801444000},{"_id":"themes/yilia/languages/ru.yml","hash":"62f84ea82a696060c481fc22d4742e6201bb9bdc","modified":1517801444000},{"_id":"themes/yilia/languages/zh-hk.yml","hash":"e702fc43556e54c396917bdf7c869d528742e28b","modified":1517801444000},{"_id":"themes/yilia/languages/fr-FR.yml","hash":"04b9a0d80d88d01e039e8077afe88f741e9620ba","modified":1517801444000},{"_id":"themes/yilia/languages/zh-Hans.yml","hash":"d2336578e14bb880d152266981c2b17523fc8742","modified":1517801444000},{"_id":"themes/yilia/languages/zh-tw.yml","hash":"005559baa96b7bb34e1efe6b031829a95d58d5e0","modified":1517801444000},{"_id":"themes/yilia/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1517801444000},{"_id":"themes/yilia/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1517801444000},{"_id":"themes/yilia/layout/layout.ejs","hash":"3a4350f23a1286345f76c949466c97a7200dae8e","modified":1517801444000},{"_id":"themes/yilia/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1517801444000},{"_id":"themes/yilia/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1517801444000},{"_id":"themes/yilia/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1517801444000},{"_id":"themes/yilia/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1517801444000},{"_id":"themes/yilia/source/css/.DS_Store","hash":"fc5a428fe40854a0ba66b4cea196c6700a57cae7","modified":1517801444000},{"_id":"themes/yilia/source/css/_extend.styl","hash":"8ab1ad313bd6707d248c5ca1ee9a5eab8d815e42","modified":1517801444000},{"_id":"themes/yilia/source/css/_variables.styl","hash":"8b63ea3c7199524b9a1541075c6f8fb2c0d0ea3d","modified":1517801444000},{"_id":"themes/yilia/source/css/style.styl","hash":"fb591be51e4e4f55db117159c84ecba4f7248f61","modified":1517801444000},{"_id":"themes/yilia/source/img/coderwall.png","hash":"fa84676c4d654e040e51fd34bfcd9f9348cd5331","modified":1517801444000},{"_id":"themes/yilia/source/img/delicious.png","hash":"9553a5f5189e4a953e04a58a49dbfa74b86b73dd","modified":1517801444000},{"_id":"themes/yilia/source/img/douban.png","hash":"e2ade003ffadd5826ee66ec23901c2d6e8607e4e","modified":1517801444000},{"_id":"themes/yilia/source/img/github.png","hash":"b84d03b32fa388dcbf149296ebd16dce6223d48d","modified":1517801444000},{"_id":"themes/yilia/source/img/facebook.png","hash":"d19ad7a0903daf26817afd8753cd97e0cc714f54","modified":1517801444000},{"_id":"themes/yilia/source/img/img-loading.png","hash":"a9cd5cd11866824f31e3d1c5e23badfeb3f73031","modified":1517801444000},{"_id":"themes/yilia/source/img/google.png","hash":"61a21fec7346fa3400b747ac9a201cf3d5bc013d","modified":1517801444000},{"_id":"themes/yilia/source/img/img-err.png","hash":"23a63ea26eb3c1d5e677d9883cf36cc1a1a1228b","modified":1517801444000},{"_id":"themes/yilia/source/img/linkedin.png","hash":"e203138fb53c257cb214e97f4e30091b9c568d2c","modified":1517801444000},{"_id":"themes/yilia/source/img/mail.png","hash":"fca8199cc77fdbd700a45bf56d091c82f4a67fe7","modified":1517801444000},{"_id":"themes/yilia/source/img/pinboard.png","hash":"0891fbb6d092fa012bf936019923383d84c6aeb0","modified":1517801444000},{"_id":"themes/yilia/source/img/scrollbar_arrow.png","hash":"d64a33c4ddfbdb89deeb6f4e3d36eb84dc4777c0","modified":1517801444000},{"_id":"themes/yilia/source/img/rss.png","hash":"430fd47340e75214c081abd05cd7410cf7c71b86","modified":1517801444000},{"_id":"themes/yilia/source/img/pinterest.png","hash":"9c72917f8779c083157c6ce7a5d62ed4874f0630","modified":1517801444000},{"_id":"themes/yilia/source/img/twitter.png","hash":"14dbb8e62d056525253bc0de13acd1723da7a934","modified":1517801444000},{"_id":"themes/yilia/source/img/stackoverflow.png","hash":"da5dfe9043055c95e479d49c78cd3b020de608f2","modified":1517801444000},{"_id":"themes/yilia/source/img/weibo.png","hash":"280dae3fd38086158b4a1b57edb94c06b1a5014b","modified":1517801444000},{"_id":"themes/yilia/source/img/zhihu.png","hash":"a6d6ef65e9ac82e613a311810391ebb90d9b1c1d","modified":1517801444000},{"_id":"themes/yilia/source/js/instagram.js","hash":"81e13cacf4947118ed1920e59b04ccf6beef6b86","modified":1517801444000},{"_id":"themes/yilia/source/js/jquery.lazyload.js","hash":"9c34c37b4dca82386648d364da913153d1db902e","modified":1517801444000},{"_id":"themes/yilia/source/js/main.js","hash":"e2633f282e377a4169649c9f17dc96036ad4fc64","modified":1517801444000},{"_id":"themes/yilia/source/js/mobile.js","hash":"387c047e661f04fbb5f5bfc4b2db617023e836ce","modified":1517801444000},{"_id":"themes/yilia/source/js/pc.js","hash":"a5397d34a04084ee089b4b1e26457ab46ecea63e","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.css","hash":"96138eaddfbd305160ddcb98a5f08555ca6cb4ee","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.js","hash":"004bb0812414554ab48067792f09e978603253b6","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/jquery.fancybox.pack.js","hash":"2da892a02778236b64076e5e8802ef0566e1d9e8","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/archive-post.ejs","hash":"5b29a383418cfdcf8d5c5719b4fc4608aaba6fe7","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/archive.ejs","hash":"a4eacc2bc1278095a0ef99f904b0634c78f980eb","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/after-footer.ejs","hash":"9f9515af1accacc02c18de0ae96d52813a07af58","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/footer.ejs","hash":"c7a93b410c5a7ce6cc295fa43c8cd96bc5c8b7d2","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/article.ejs","hash":"420b94c78832456686ebd9831a5bfcb05365645a","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/google-analytics.ejs","hash":"1ccc627d7697e68fddc367c73ac09920457e5b35","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/header.ejs","hash":"b69855e07b65117769adc515cb64b803932068c9","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/head.ejs","hash":"2bbf5aad03f54055d9d7852e70ff7e6952a41f26","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/mathjax.ejs","hash":"34b2d7050db88fed9f70b8233f16f451bad501f4","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/left-col.ejs","hash":"b03e8424b4798d4887801afdfae457fbf6027838","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/mobile-nav.ejs","hash":"6a7a2a4960dabf9d7cd523573da7869eebf4b02d","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/archive.styl","hash":"8b349f1605024dcdae054e04f02d71a2e84957c2","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/article.styl","hash":"872fc4e63509fef885c939e5fd70e6ed439beced","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/footer.styl","hash":"7ca837a4cc34db1c35f01baec85eb10ccc64ea86","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/highlight.styl","hash":"08d3205dde3235f3e6881126268e6c473f46a8ac","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/instagram.styl","hash":"8a7b07bf5ea2d3588c0019f722c245bb1a8696af","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/main.styl","hash":"c368f1533053d4cffdf0ad982603271400b08e33","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/header.styl","hash":"67e59feb18eee6026717cb440d86ab9551782628","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/mobile-slider.styl","hash":"e19c7fae6968ad3ea6cfc110900a991f9b5fce31","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/mobile.styl","hash":"3a03b04ef8ac305aa5dbf7b9db99cd9377d07383","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/page.styl","hash":"720b5b169bc28ccba3794efce9b7cd39f243dec7","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/wheelmenu.styl","hash":"9e57421eab562ea13d0ed2b2e1415eee79fa23d0","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/scroll.styl","hash":"5539a38f9acd603d453a0ea0d8ce10893cf83d22","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/share.styl","hash":"22697b9a9877ab9f018364feb57aeea4a8313c9a","modified":1517801444000},{"_id":"themes/yilia/source/css/_partial/tagcloud.styl","hash":"af0115de5c6455f899a2e09225b50224982c039d","modified":1517801444000},{"_id":"themes/yilia/source/css/_util/grid.styl","hash":"1aa883ab432d9e4139c89dcbd40ae2bd1528d029","modified":1517801444000},{"_id":"themes/yilia/source/css/_util/mixin.styl","hash":"429bad87fc156eacf226c5e35b0eafc277f2504b","modified":1517801444000},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.eot","hash":"3ce87b82c7a4ffdf65e96765c2ffda10b1a283c6","modified":1517801444000},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.svgz","hash":"4bfdd33ed702e32ae01399fcc2652377f78e7626","modified":1517801444000},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.ttf","hash":"1480b8101b02da9bc4c60341b5e185e63e585064","modified":1517801444000},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.woff","hash":"cafc4ac5761a0a252d33dce4ea3952cf9a38d832","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-buttons.js","hash":"4c9c395d705d22af7da06870d18f434e2a2eeaf9","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"83cdfea43632b613771691a11f56f99d85fb6dbd","modified":1517801444000},{"_id":"themes/yilia/source/fancybox/helpers/jquery.fancybox-media.js","hash":"e14c32cc6823b81b2f758512f13ed8eb9ef2b454","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/category.ejs","hash":"27fab3e6ccc41c075dc4c5ba3ca9e7f3b6247945","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/date.ejs","hash":"06d8914b5aef73b5ec2cabb0105e275ff821b321","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/duoshuo.ejs","hash":"f6b4c4eaafb5ac386273354b5f64a26139b7a3b0","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/share_addthis.ejs","hash":"4ab6cab2a975a4df8419448b33dec4724279d85c","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/share_jia.ejs","hash":"ae57061bd445524180bc341143d275ad3a58033d","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/tag.ejs","hash":"acf1b9d79ccec172881f9f0080e96667f4178885","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/nav.ejs","hash":"c115c282eebfb6b18612d2d8733272c270b03066","modified":1517801444000},{"_id":"themes/yilia/layout/_partial/post/title.ejs","hash":"d4a460a35e2112d0c7414fd5e19b3a16093f1caf","modified":1517801444000},{"_id":"themes/yilia/source/css/fonts/fontawesome-webfont.svg","hash":"ba13657479b46daecb6336bfe376f84cef3ae58b","modified":1517801444000},{"_id":"public/categories/index.html","hash":"19512bd206d21d43c5555424ab94314cf9efc6fd","modified":1520560786536},{"_id":"public/about/index.html","hash":"1f27cdb43510476b1cd9c0fee762365ea45356e7","modified":1520560786553},{"_id":"public/tags/index.html","hash":"55be1f5c6df1fef539ec7166ae0cafa8141ffab0","modified":1520560786553},{"_id":"public/2016/04/07/PandoraBox_ChinaDNS_Shadowsocks fuck_gfw/index.html","hash":"89843a49e5b5eee7d26c944fea8f9e72b24d52ac","modified":1520560786554},{"_id":"public/archives/2016/index.html","hash":"9484ec5b24269b4e5987c927ef5e50112245bfc3","modified":1520560786554},{"_id":"public/archives/index.html","hash":"fb4ea338188a32fca60cd4fb9db05aafdd455ec2","modified":1520560786554},{"_id":"public/archives/2016/03/index.html","hash":"c2076abe1f584013d69cb36d0dee014918bde2dd","modified":1520560786554},{"_id":"public/archives/2016/04/index.html","hash":"7a54f72f06c8015f09f58e765e5a901315913d69","modified":1520560786554},{"_id":"public/archives/2017/index.html","hash":"01e816f3464d52688ab1bdf691e79e10d2d4c665","modified":1520560786555},{"_id":"public/archives/2017/07/index.html","hash":"e6ae993bb216718241beec1a7f0cfa048e82f2e8","modified":1520560786555},{"_id":"public/archives/2018/index.html","hash":"62e67711ea7492f9db09e859f721439184b6e7c1","modified":1520560786555},{"_id":"public/archives/2018/03/index.html","hash":"d6f9213d671fe6bc0d6e555c1e63518f273354fb","modified":1520560786555},{"_id":"public/categories/notes/index.html","hash":"06ea849f32665269fd40ebb29df905045fb04fd1","modified":1520560786555},{"_id":"public/2018/03/08/hhvm/index.html","hash":"2a2b6562ea2d5cf01f259d24802266392572b19c","modified":1520560786555},{"_id":"public/2017/07/31/neteasy_music_spider/index.html","hash":"6612725c91c427a39735016daaca94adcee9eee9","modified":1520560786555},{"_id":"public/2016/03/29/gitlab_update_notes/index.html","hash":"7615ac7e97df6219cce6abbc43f9051d70189470","modified":1520560786555},{"_id":"public/tags/shadowsocks/index.html","hash":"77026fc10c02ea5520c8314dd40089355704ae65","modified":1520560786560},{"_id":"public/tags/Fuck-GFW/index.html","hash":"2ad81b77f3842f6a119452ccf93a21d62568446a","modified":1520560786560},{"_id":"public/tags/openwrt/index.html","hash":"95a0901ffd244308824fdd184f19a8785277a9e2","modified":1520560786560},{"_id":"public/tags/Gitlab/index.html","hash":"8236965f245a7c4c9792864c2edc9182ee58fafb","modified":1520560786560},{"_id":"public/tags/pandorabox/index.html","hash":"06a735f0444e4ff54b3fc79b609b03a4e77a7cfe","modified":1520560786560},{"_id":"public/tags/网易云音乐/index.html","hash":"77eb26c2c43d8f93f1d67de5577a838976d71747","modified":1520560786560},{"_id":"public/tags/php/index.html","hash":"28f3c552222d790c87e9fbf4e69e5758d90b7432","modified":1520560786560},{"_id":"public/index.html","hash":"2aaa1abd91fb05ece94b797e105c68ab8374d08f","modified":1520560786560},{"_id":"public/CNAME","hash":"e0b22c8da97e51c57815af75a4bb282f6af2abfe","modified":1520560786560},{"_id":"public/img/coderwall.png","hash":"fa84676c4d654e040e51fd34bfcd9f9348cd5331","modified":1520560786560},{"_id":"public/img/douban.png","hash":"e2ade003ffadd5826ee66ec23901c2d6e8607e4e","modified":1520560786560},{"_id":"public/img/github.png","hash":"b84d03b32fa388dcbf149296ebd16dce6223d48d","modified":1520560786560},{"_id":"public/img/delicious.png","hash":"9553a5f5189e4a953e04a58a49dbfa74b86b73dd","modified":1520560786560},{"_id":"public/img/img-loading.png","hash":"a9cd5cd11866824f31e3d1c5e23badfeb3f73031","modified":1520560786560},{"_id":"public/img/facebook.png","hash":"d19ad7a0903daf26817afd8753cd97e0cc714f54","modified":1520560786561},{"_id":"public/img/google.png","hash":"61a21fec7346fa3400b747ac9a201cf3d5bc013d","modified":1520560786561},{"_id":"public/img/img-err.png","hash":"23a63ea26eb3c1d5e677d9883cf36cc1a1a1228b","modified":1520560786561},{"_id":"public/img/linkedin.png","hash":"e203138fb53c257cb214e97f4e30091b9c568d2c","modified":1520560786561},{"_id":"public/img/pinboard.png","hash":"0891fbb6d092fa012bf936019923383d84c6aeb0","modified":1520560786561},{"_id":"public/img/mail.png","hash":"fca8199cc77fdbd700a45bf56d091c82f4a67fe7","modified":1520560786561},{"_id":"public/img/scrollbar_arrow.png","hash":"d64a33c4ddfbdb89deeb6f4e3d36eb84dc4777c0","modified":1520560786561},{"_id":"public/img/rss.png","hash":"430fd47340e75214c081abd05cd7410cf7c71b86","modified":1520560786561},{"_id":"public/img/twitter.png","hash":"14dbb8e62d056525253bc0de13acd1723da7a934","modified":1520560786561},{"_id":"public/img/pinterest.png","hash":"9c72917f8779c083157c6ce7a5d62ed4874f0630","modified":1520560786561},{"_id":"public/img/stackoverflow.png","hash":"da5dfe9043055c95e479d49c78cd3b020de608f2","modified":1520560786561},{"_id":"public/img/weibo.png","hash":"280dae3fd38086158b4a1b57edb94c06b1a5014b","modified":1520560786561},{"_id":"public/img/zhihu.png","hash":"a6d6ef65e9ac82e613a311810391ebb90d9b1c1d","modified":1520560786561},{"_id":"public/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1520560786561},{"_id":"public/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1520560786561},{"_id":"public/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1520560786561},{"_id":"public/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1520560786561},{"_id":"public/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1520560786562},{"_id":"public/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1520560786562},{"_id":"public/css/fonts/fontawesome-webfont.eot","hash":"3ce87b82c7a4ffdf65e96765c2ffda10b1a283c6","modified":1520560786562},{"_id":"public/css/fonts/fontawesome-webfont.svgz","hash":"4bfdd33ed702e32ae01399fcc2652377f78e7626","modified":1520560786562},{"_id":"public/css/fonts/fontawesome-webfont.ttf","hash":"1480b8101b02da9bc4c60341b5e185e63e585064","modified":1520560786562},{"_id":"public/css/fonts/fontawesome-webfont.woff","hash":"cafc4ac5761a0a252d33dce4ea3952cf9a38d832","modified":1520560786562},{"_id":"public/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1520560786562},{"_id":"public/css/fonts/fontawesome-webfont.svg","hash":"ba13657479b46daecb6336bfe376f84cef3ae58b","modified":1520560787092},{"_id":"public/js/jquery.lazyload.js","hash":"c11a2e7b330d16d06feabd0a8477099adf9d6799","modified":1520560787097},{"_id":"public/js/pc.js","hash":"fdbc039fc9ffa70815b5fc4daaa587ae29693f10","modified":1520560787098},{"_id":"public/js/main.js","hash":"0640b68a76fab3c693b3cd1e4d04d14be1e53940","modified":1520560787098},{"_id":"public/js/instagram.js","hash":"f19adbcc0dac33536bc6660598059048ec901882","modified":1520560787098},{"_id":"public/js/mobile.js","hash":"b68cc01d24e80973c48205f551da87f3f3427644","modified":1520560787098},{"_id":"public/fancybox/jquery.fancybox.css","hash":"b6aa6692c2e5f8bd74d96827b78570f0c5683c20","modified":1520560787098},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1520560787098},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1520560787098},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1520560787098},{"_id":"public/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1520560787098},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1520560787098},{"_id":"public/css/style.css","hash":"5151ff085d4031c3ce5d043148e723427c608ac5","modified":1520560787100},{"_id":"public/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1520560787100},{"_id":"public/fancybox/jquery.fancybox.js","hash":"a82597493d75ea989ca586e09173cff332efe41e","modified":1520560787100}],"Category":[{"name":"notes","_id":"cjejamqyt0004wctxdhh2dt2f"}],"Data":[],"Page":[{"layout":"categories","title":"categories","_content":"","source":"categories/index.md","raw":"layout: categories\ntitle: categories\n---","date":"2076-11-29T08:54:34.955Z","updated":"2018-02-05T03:30:44.000Z","path":"categories/index.html","comments":1,"_id":"cjejamqyk0000wctxb02gdr8o","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"关于我","date":"2015-10-28T07:48:17.000Z","_content":"关于我","source":"about/index.md","raw":"title: 关于我\ndate: 2015-10-28 15:48:17\n---\n关于我","updated":"2018-02-05T03:30:44.000Z","path":"about/index.html","comments":1,"layout":"page","_id":"cjejamqyp0002wctxpxyj2uh5","content":"<p>关于我</p>\n","site":{"data":{}},"excerpt":"","more":"<p>关于我</p>\n"},{"layout":"tags","title":"tags","_content":"","source":"tags/index.md","raw":"layout: tags\ntitle: tags\n---","date":"2076-11-29T08:54:34.955Z","updated":"2018-02-05T03:30:44.000Z","path":"tags/index.html","comments":1,"_id":"cjejamqyv0006wctxzc3w8rsa","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"PandoraBox 配合ChinaDNS,Shadowsocks实现智能翻墙","date":"2016-04-07T13:00:00.000Z","_content":"\n>必备:\n>openwrt或者PandoraBox路由器一个（推荐PandoraBox，内置Shadwosocks,ChinaDNS）,\n>Shadowsocks账号\n>刷路由器在这里就不写了，google一大堆教程\n\nPandoraBox系统内置Shadwosocks,ChinaDNS等服务，十分方便，如果是openwrt系统要自己安装\n\n### 1. 解决dns污染的问题\n打开 `服务`>`ChinaDNS`\n\n<!--more-->\n\n![ChinaDNS设置](https://i.imgur.com/ucERfzT.png)\n\n>之前就是这里设置错了没在意看，到时只能上去Google，却上不去Youtube,Facebook等（Google还没被DNS污染之前，现在已经加入DNS污染全家桶了）。\n\n### 2. 设置Shadowsocks\n\n打开 `服务`>`Shadowsocks`\n\n![Shadowsocks设置](https://i.imgur.com/L3NtI5g.png)\n\n>填好配置文件，勾选透明代理一项，不要勾选Socks5代理。如果服务器支持UDP转发，可以勾选UDP转发一项，保存\n\n### 3. 设置DNS转发\n\n打开 `网络`>`DHCP/DNS`\n\n![DNS设置](https://i.imgur.com/kuPmS1o.png)\n\n把DNS转发一项设置为127.0.0.1#1053(1053是第一步里面ChinaDNS设置的端口)\n\n打开 `网络`>`DHCP/DNS`>`HOSTS和解析文件`选项卡,勾选`忽略解析文件一项 `\n\n保存即可。\n\n","source":"_posts/PandoraBox_ChinaDNS_Shadowsocks fuck_gfw.md","raw":"# PandoraBox 配合ChinaDNS,Shadowsocks实现智能翻墙\ntitle: PandoraBox 配合ChinaDNS,Shadowsocks实现智能翻墙\ndate: 2016-04-07 21:00\ncategories:\n- notes\ntags:\n- Fuck GFW\n- shadowsocks\n- openwrt\n- pandorabox\n------\n\n>必备:\n>openwrt或者PandoraBox路由器一个（推荐PandoraBox，内置Shadwosocks,ChinaDNS）,\n>Shadowsocks账号\n>刷路由器在这里就不写了，google一大堆教程\n\nPandoraBox系统内置Shadwosocks,ChinaDNS等服务，十分方便，如果是openwrt系统要自己安装\n\n### 1. 解决dns污染的问题\n打开 `服务`>`ChinaDNS`\n\n<!--more-->\n\n![ChinaDNS设置](https://i.imgur.com/ucERfzT.png)\n\n>之前就是这里设置错了没在意看，到时只能上去Google，却上不去Youtube,Facebook等（Google还没被DNS污染之前，现在已经加入DNS污染全家桶了）。\n\n### 2. 设置Shadowsocks\n\n打开 `服务`>`Shadowsocks`\n\n![Shadowsocks设置](https://i.imgur.com/L3NtI5g.png)\n\n>填好配置文件，勾选透明代理一项，不要勾选Socks5代理。如果服务器支持UDP转发，可以勾选UDP转发一项，保存\n\n### 3. 设置DNS转发\n\n打开 `网络`>`DHCP/DNS`\n\n![DNS设置](https://i.imgur.com/kuPmS1o.png)\n\n把DNS转发一项设置为127.0.0.1#1053(1053是第一步里面ChinaDNS设置的端口)\n\n打开 `网络`>`DHCP/DNS`>`HOSTS和解析文件`选项卡,勾选`忽略解析文件一项 `\n\n保存即可。\n\n","slug":"PandoraBox_ChinaDNS_Shadowsocks fuck_gfw","published":1,"updated":"2018-02-05T03:30:44.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjejamqyl0001wctxdyqiqa21","content":"<blockquote>\n<p>必备:<br>openwrt或者PandoraBox路由器一个（推荐PandoraBox，内置Shadwosocks,ChinaDNS）,<br>Shadowsocks账号<br>刷路由器在这里就不写了，google一大堆教程</p>\n</blockquote>\n<p>PandoraBox系统内置Shadwosocks,ChinaDNS等服务，十分方便，如果是openwrt系统要自己安装</p>\n<h3 id=\"1-解决dns污染的问题\"><a href=\"#1-解决dns污染的问题\" class=\"headerlink\" title=\"1. 解决dns污染的问题\"></a>1. 解决dns污染的问题</h3><p>打开 <code>服务</code>&gt;<code>ChinaDNS</code></p>\n<a id=\"more\"></a>\n<p><img src=\"https://i.imgur.com/ucERfzT.png\" alt=\"ChinaDNS设置\"></p>\n<blockquote>\n<p>之前就是这里设置错了没在意看，到时只能上去Google，却上不去Youtube,Facebook等（Google还没被DNS污染之前，现在已经加入DNS污染全家桶了）。</p>\n</blockquote>\n<h3 id=\"2-设置Shadowsocks\"><a href=\"#2-设置Shadowsocks\" class=\"headerlink\" title=\"2. 设置Shadowsocks\"></a>2. 设置Shadowsocks</h3><p>打开 <code>服务</code>&gt;<code>Shadowsocks</code></p>\n<p><img src=\"https://i.imgur.com/L3NtI5g.png\" alt=\"Shadowsocks设置\"></p>\n<blockquote>\n<p>填好配置文件，勾选透明代理一项，不要勾选Socks5代理。如果服务器支持UDP转发，可以勾选UDP转发一项，保存</p>\n</blockquote>\n<h3 id=\"3-设置DNS转发\"><a href=\"#3-设置DNS转发\" class=\"headerlink\" title=\"3. 设置DNS转发\"></a>3. 设置DNS转发</h3><p>打开 <code>网络</code>&gt;<code>DHCP/DNS</code></p>\n<p><img src=\"https://i.imgur.com/kuPmS1o.png\" alt=\"DNS设置\"></p>\n<p>把DNS转发一项设置为127.0.0.1#1053(1053是第一步里面ChinaDNS设置的端口)</p>\n<p>打开 <code>网络</code>&gt;<code>DHCP/DNS</code>&gt;<code>HOSTS和解析文件</code>选项卡,勾选<code>忽略解析文件一项</code></p>\n<p>保存即可。</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>必备:<br>openwrt或者PandoraBox路由器一个（推荐PandoraBox，内置Shadwosocks,ChinaDNS）,<br>Shadowsocks账号<br>刷路由器在这里就不写了，google一大堆教程</p>\n</blockquote>\n<p>PandoraBox系统内置Shadwosocks,ChinaDNS等服务，十分方便，如果是openwrt系统要自己安装</p>\n<h3 id=\"1-解决dns污染的问题\"><a href=\"#1-解决dns污染的问题\" class=\"headerlink\" title=\"1. 解决dns污染的问题\"></a>1. 解决dns污染的问题</h3><p>打开 <code>服务</code>&gt;<code>ChinaDNS</code></p>","more":"<p><img src=\"https://i.imgur.com/ucERfzT.png\" alt=\"ChinaDNS设置\"></p>\n<blockquote>\n<p>之前就是这里设置错了没在意看，到时只能上去Google，却上不去Youtube,Facebook等（Google还没被DNS污染之前，现在已经加入DNS污染全家桶了）。</p>\n</blockquote>\n<h3 id=\"2-设置Shadowsocks\"><a href=\"#2-设置Shadowsocks\" class=\"headerlink\" title=\"2. 设置Shadowsocks\"></a>2. 设置Shadowsocks</h3><p>打开 <code>服务</code>&gt;<code>Shadowsocks</code></p>\n<p><img src=\"https://i.imgur.com/L3NtI5g.png\" alt=\"Shadowsocks设置\"></p>\n<blockquote>\n<p>填好配置文件，勾选透明代理一项，不要勾选Socks5代理。如果服务器支持UDP转发，可以勾选UDP转发一项，保存</p>\n</blockquote>\n<h3 id=\"3-设置DNS转发\"><a href=\"#3-设置DNS转发\" class=\"headerlink\" title=\"3. 设置DNS转发\"></a>3. 设置DNS转发</h3><p>打开 <code>网络</code>&gt;<code>DHCP/DNS</code></p>\n<p><img src=\"https://i.imgur.com/kuPmS1o.png\" alt=\"DNS设置\"></p>\n<p>把DNS转发一项设置为127.0.0.1#1053(1053是第一步里面ChinaDNS设置的端口)</p>\n<p>打开 <code>网络</code>&gt;<code>DHCP/DNS</code>&gt;<code>HOSTS和解析文件</code>选项卡,勾选<code>忽略解析文件一项</code></p>\n<p>保存即可。</p>"},{"title":"Gitlab 源码安装版 升级笔记","date":"2016-03-29T07:00:00.000Z","_content":"\n\n# Gitlab 升级笔记\n>适用于使用源码安装的Gitlab\n\n>GitLab Community Edition 8.3.2 fbb8b6e>\n\n#### 0. Backup\n```\ncd /home/git/gitlab\nsudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n```\n备份完成后会在`/home/git/gitlab/backup`文件夹下生成已时间戳命名的文件`1459217332_gitlab_backup.tar`\n\n#### 1. Stop server\n```\nsudo service gitlab stop\n```\n<!--more-->\n\n#### 2.Run GitLab upgrade tool\nPlease replace X.X.X with the [latest GitLab release](https://packages.gitlab.com/gitlab/gitlab-ce).\n\nGitLab 7.9 adds `nodejs` as a dependency. GitLab 7.6 adds `libkrb5-dev` as a dependency (installed by default on Ubuntu and OSX). GitLab 7.2 adds `pkg-config` and `cmake` as dependency. Please check the dependencies in the [installation guide](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#1-packages-dependencies).\n\n```\ncd /home/git/gitlab\nsudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute'\n\n# to perform a non-interactive install (no user input required) you can add -y\n# sudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute' -- -y\n```\n\n*小插曲：*执行命令时报错\n\n```\nfrom /home/git/gitlab/lib/gitlab/upgrader.rb:74:in `upgrade'\n\n    from /home/git/gitlab/lib/gitlab/upgrader.rb:22:in `execute'\n\n    from -e:7:in `<main>'\n```\n解决办法\n\n```\nOpen /home/git/gitlab/lib/gitlab/upgrader.rb in editor\nReplace all #{Gitlab.config.git.bin_path} by git and save\nRun upgrader.rb as usual\n```\n\n\nI have the same problem upgrading from 8.5.1 to 8.5.5. Replacing `Gitlab.config.git.bin_path` with `git` fixed it.\nThis is the search and replace command to run in vi: `%s/#{Gitlab.config.git.bin_path}/git/g`\n\n#### 3. Start application\n```\nsudo service gitlab start\nsudo service nginx restart\n```\n#### 4. Check application status\nCheck if GitLab and its dependencies are configured correctly:\n\n```\nsudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\nIf all items are green, then congratulations upgrade is complete!\n\n#### 5. Upgrade GitLab Shell\nGitLab Shell might be outdated, running the commands below ensures you're using a compatible version:\n\n```\ncd /home/git/gitlab-shell\nsudo -u git -H git fetch\nsudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`\n```\n#### One line upgrade command\n\nYou've read through the entire guide and probably already did all the steps one by one.\nBelow is a one line command with step 1 to 5 for the next time you upgrade.\nPlease replace X.X.X with the [latest GitLab release](https://packages.gitlab.com/gitlab/gitlab-ce).\n\n```\ncd /home/git/gitlab; \\\n  sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production; \\\n  sudo service gitlab stop; \\\n  sudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute' -- -y; \\\n  cd /home/git/gitlab-shell; \\\n  sudo -u git -H git fetch; \\\n  sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`; \\\n  cd /home/git/gitlab; \\\n  sudo service gitlab start; \\\n  sudo service nginx restart; \\\n  sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n####Note:\n阿里云服务器ruby源不稳定。换国内的源\n\n```\ngem sources --add https://ruby.taobao.org/ --remove https://rubygems.org/\ngem sources -l\n# 请确保只有 ruby.taobao.org\ngem install rails\n```\n\n```\nsudo -u git bundle install\n```\n\n安装完成之后 `update init script`\n\n```\nrm /etc/init.d/gitlab\nsudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n升级是由于是从7.x 到8.x 样式变化很大，所以执行完后样式错乱。后来找了些文档才发现要重新生产asset文件。\n\n```\nsudo -u git -H bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n```\n重启\n\n```\nservice gitlab start\nservice nginx restart\n```\nDone!\n\n\n","source":"_posts/gitlab_update_notes.md","raw":"title: Gitlab 源码安装版 升级笔记\ndate: 2016-03-29 15:00\ncategories:\n- notes\ntags:\n- Gitlab\n---\n\n\n# Gitlab 升级笔记\n>适用于使用源码安装的Gitlab\n\n>GitLab Community Edition 8.3.2 fbb8b6e>\n\n#### 0. Backup\n```\ncd /home/git/gitlab\nsudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n```\n备份完成后会在`/home/git/gitlab/backup`文件夹下生成已时间戳命名的文件`1459217332_gitlab_backup.tar`\n\n#### 1. Stop server\n```\nsudo service gitlab stop\n```\n<!--more-->\n\n#### 2.Run GitLab upgrade tool\nPlease replace X.X.X with the [latest GitLab release](https://packages.gitlab.com/gitlab/gitlab-ce).\n\nGitLab 7.9 adds `nodejs` as a dependency. GitLab 7.6 adds `libkrb5-dev` as a dependency (installed by default on Ubuntu and OSX). GitLab 7.2 adds `pkg-config` and `cmake` as dependency. Please check the dependencies in the [installation guide](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#1-packages-dependencies).\n\n```\ncd /home/git/gitlab\nsudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute'\n\n# to perform a non-interactive install (no user input required) you can add -y\n# sudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute' -- -y\n```\n\n*小插曲：*执行命令时报错\n\n```\nfrom /home/git/gitlab/lib/gitlab/upgrader.rb:74:in `upgrade'\n\n    from /home/git/gitlab/lib/gitlab/upgrader.rb:22:in `execute'\n\n    from -e:7:in `<main>'\n```\n解决办法\n\n```\nOpen /home/git/gitlab/lib/gitlab/upgrader.rb in editor\nReplace all #{Gitlab.config.git.bin_path} by git and save\nRun upgrader.rb as usual\n```\n\n\nI have the same problem upgrading from 8.5.1 to 8.5.5. Replacing `Gitlab.config.git.bin_path` with `git` fixed it.\nThis is the search and replace command to run in vi: `%s/#{Gitlab.config.git.bin_path}/git/g`\n\n#### 3. Start application\n```\nsudo service gitlab start\nsudo service nginx restart\n```\n#### 4. Check application status\nCheck if GitLab and its dependencies are configured correctly:\n\n```\nsudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\nIf all items are green, then congratulations upgrade is complete!\n\n#### 5. Upgrade GitLab Shell\nGitLab Shell might be outdated, running the commands below ensures you're using a compatible version:\n\n```\ncd /home/git/gitlab-shell\nsudo -u git -H git fetch\nsudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`\n```\n#### One line upgrade command\n\nYou've read through the entire guide and probably already did all the steps one by one.\nBelow is a one line command with step 1 to 5 for the next time you upgrade.\nPlease replace X.X.X with the [latest GitLab release](https://packages.gitlab.com/gitlab/gitlab-ce).\n\n```\ncd /home/git/gitlab; \\\n  sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production; \\\n  sudo service gitlab stop; \\\n  sudo -u git -H ruby -Ilib -e 'require \"gitlab/upgrader\"' -e 'class Gitlab::Upgrader' -e 'def latest_version_raw' -e '\"vX.X.X\"' -e 'end' -e 'end' -e 'Gitlab::Upgrader.new.execute' -- -y; \\\n  cd /home/git/gitlab-shell; \\\n  sudo -u git -H git fetch; \\\n  sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`; \\\n  cd /home/git/gitlab; \\\n  sudo service gitlab start; \\\n  sudo service nginx restart; \\\n  sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n####Note:\n阿里云服务器ruby源不稳定。换国内的源\n\n```\ngem sources --add https://ruby.taobao.org/ --remove https://rubygems.org/\ngem sources -l\n# 请确保只有 ruby.taobao.org\ngem install rails\n```\n\n```\nsudo -u git bundle install\n```\n\n安装完成之后 `update init script`\n\n```\nrm /etc/init.d/gitlab\nsudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n升级是由于是从7.x 到8.x 样式变化很大，所以执行完后样式错乱。后来找了些文档才发现要重新生产asset文件。\n\n```\nsudo -u git -H bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n```\n重启\n\n```\nservice gitlab start\nservice nginx restart\n```\nDone!\n\n\n","slug":"gitlab_update_notes","published":1,"updated":"2018-02-05T03:30:44.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjejamqyq0003wctxya7bfi2a","content":"<h1 id=\"Gitlab-升级笔记\"><a href=\"#Gitlab-升级笔记\" class=\"headerlink\" title=\"Gitlab 升级笔记\"></a>Gitlab 升级笔记</h1><blockquote>\n<p>适用于使用源码安装的Gitlab</p>\n<p>GitLab Community Edition 8.3.2 fbb8b6e&gt;</p>\n</blockquote>\n<h4 id=\"0-Backup\"><a href=\"#0-Backup\" class=\"headerlink\" title=\"0. Backup\"></a>0. Backup</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd <span class=\"regexp\">/home/</span>git/gitlab</div><div class=\"line\">sudo -u git -H bundle exec rake <span class=\"string\">gitlab:</span><span class=\"string\">backup:</span>create RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>备份完成后会在<code>/home/git/gitlab/backup</code>文件夹下生成已时间戳命名的文件<code>1459217332_gitlab_backup.tar</code></p>\n<h4 id=\"1-Stop-server\"><a href=\"#1-Stop-server\" class=\"headerlink\" title=\"1. Stop server\"></a>1. Stop server</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo<span class=\"built_in\"> service </span>gitlab stop</div></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h4 id=\"2-Run-GitLab-upgrade-tool\"><a href=\"#2-Run-GitLab-upgrade-tool\" class=\"headerlink\" title=\"2.Run GitLab upgrade tool\"></a>2.Run GitLab upgrade tool</h4><p>Please replace X.X.X with the <a href=\"https://packages.gitlab.com/gitlab/gitlab-ce\" target=\"_blank\" rel=\"noopener\">latest GitLab release</a>.</p>\n<p>GitLab 7.9 adds <code>nodejs</code> as a dependency. GitLab 7.6 adds <code>libkrb5-dev</code> as a dependency (installed by default on Ubuntu and OSX). GitLab 7.2 adds <code>pkg-config</code> and <code>cmake</code> as dependency. Please check the dependencies in the <a href=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#1-packages-dependencies\" target=\"_blank\" rel=\"noopener\">installation guide</a>.</p>\n<figure class=\"highlight flix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab</div><div class=\"line\">sudo -u git -H ruby -Ilib -e 'require <span class=\"string\">\"gitlab/upgrader\"</span>' -e '<span class=\"keyword\">class</span> Gitlab::Upgrader' -e '<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">latest_version_raw</span>' <span class=\"title\">-e</span> '\"<span class=\"title\">vX</span>.<span class=\"title\">X</span>.<span class=\"title\">X</span>\"' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">Gitlab</span></span>::Upgrader.new.execute'</div><div class=\"line\"></div><div class=\"line\"># to perform a non-interactive install (no user input required) you can add -y</div><div class=\"line\"># sudo -u git -H ruby -Ilib -e 'require <span class=\"string\">\"gitlab/upgrader\"</span>' -e '<span class=\"keyword\">class</span> Gitlab::Upgrader' -e '<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">latest_version_raw</span>' <span class=\"title\">-e</span> '\"<span class=\"title\">vX</span>.<span class=\"title\">X</span>.<span class=\"title\">X</span>\"' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">Gitlab</span></span>::Upgrader.new.execute' -- -y</div></pre></td></tr></table></figure>\n<p><em>小插曲：</em>执行命令时报错</p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">from /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span>:74:<span class=\"title\">in</span> `<span class=\"title\">upgrade</span>'</span></div><div class=\"line\"></div><div class=\"line\">    from /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span>:22:<span class=\"title\">in</span> `<span class=\"title\">execute</span>'</span></div><div class=\"line\"></div><div class=\"line\">    from -<span class=\"symbol\">e:</span><span class=\"number\">7</span>:in <span class=\"string\">`&lt;main&gt;'</span></div></pre></td></tr></table></figure>\n<p>解决办法</p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">Open /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span> <span class=\"title\">in</span> <span class=\"title\">editor</span></span></div><div class=\"line\">Replace all <span class=\"comment\">#&#123;Gitlab.config.git.bin_path&#125; by git and save</span></div><div class=\"line\">Run upgrader.rb <span class=\"keyword\">as</span> usual</div></pre></td></tr></table></figure>\n<p>I have the same problem upgrading from 8.5.1 to 8.5.5. Replacing <code>Gitlab.config.git.bin_path</code> with <code>git</code> fixed it.<br>This is the search and replace command to run in vi: <code>%s/#{Gitlab.config.git.bin_path}/git/g</code></p>\n<h4 id=\"3-Start-application\"><a href=\"#3-Start-application\" class=\"headerlink\" title=\"3. Start application\"></a>3. Start application</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo<span class=\"built_in\"> service </span>gitlab start</div><div class=\"line\">sudo<span class=\"built_in\"> service </span>nginx restart</div></pre></td></tr></table></figure>\n<h4 id=\"4-Check-application-status\"><a href=\"#4-Check-application-status\" class=\"headerlink\" title=\"4. Check application status\"></a>4. Check application status</h4><p>Check if GitLab and its dependencies are configured correctly:</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo -u git -H bundle exec rake gitlab:check <span class=\"attribute\">RAILS_ENV</span>=production</div></pre></td></tr></table></figure>\n<p>If all items are green, then congratulations upgrade is complete!</p>\n<h4 id=\"5-Upgrade-GitLab-Shell\"><a href=\"#5-Upgrade-GitLab-Shell\" class=\"headerlink\" title=\"5. Upgrade GitLab Shell\"></a>5. Upgrade GitLab Shell</h4><p>GitLab Shell might be outdated, running the commands below ensures you’re using a compatible version:</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab-<span class=\"keyword\">shell</span><span class=\"bash\"></span></div><div class=\"line\"><span class=\"bash\">sudo -u git -H git fetch</span></div><div class=\"line\"><span class=\"bash\">sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`</span></div></pre></td></tr></table></figure>\n<h4 id=\"One-line-upgrade-command\"><a href=\"#One-line-upgrade-command\" class=\"headerlink\" title=\"One line upgrade command\"></a>One line upgrade command</h4><p>You’ve read through the entire guide and probably already did all the steps one by one.<br>Below is a one line command with step 1 to 5 for the next time you upgrade.<br>Please replace X.X.X with the <a href=\"https://packages.gitlab.com/gitlab/gitlab-ce\" target=\"_blank\" rel=\"noopener\">latest GitLab release</a>.</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service gitlab stop; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H ruby -Ilib -e <span class=\"string\">'require \"gitlab/upgrader\"'</span> -e <span class=\"string\">'class Gitlab::Upgrader'</span> -e <span class=\"string\">'def latest_version_raw'</span> -e <span class=\"string\">'\"vX.X.X\"'</span> -e <span class=\"string\">'end'</span> -e <span class=\"string\">'end'</span> -e <span class=\"string\">'Gitlab::Upgrader.new.execute'</span> -- -y; <span class=\"string\">\\</span></div><div class=\"line\">  cd /home/git/gitlab-shell; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H git fetch; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`; <span class=\"string\">\\</span></div><div class=\"line\">  cd /home/git/gitlab; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service gitlab start; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service nginx restart; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>####Note:<br>阿里云服务器ruby源不稳定。换国内的源</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">gem sources --<span class=\"built_in\">add</span> http<span class=\"variable\">s:</span>//<span class=\"keyword\">ruby</span>.taobao.org/ --<span class=\"built_in\">remove</span> http<span class=\"variable\">s:</span>//rubygems.org/</div><div class=\"line\">gem sources -<span class=\"keyword\">l</span></div><div class=\"line\"># 请确保只有 <span class=\"keyword\">ruby</span>.taobao.org</div><div class=\"line\">gem install rails</div></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">sudo</span> -u git <span class=\"keyword\">bundle </span>install</div></pre></td></tr></table></figure>\n<p>安装完成之后 <code>update init script</code></p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm /etc/init.d/gitlab</div><div class=\"line\">sudo cp <span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">support</span>/<span class=\"title\">init</span>.<span class=\"title\">d</span>/<span class=\"title\">gitlab</span> /<span class=\"title\">etc</span>/<span class=\"title\">init</span>.<span class=\"title\">d</span>/<span class=\"title\">gitlab</span></span></div></pre></td></tr></table></figure>\n<p>升级是由于是从7.x 到8.x 样式变化很大，所以执行完后样式错乱。后来找了些文档才发现要重新生产asset文件。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo -u git -H bundle exec rake <span class=\"string\">assets:</span>clean <span class=\"string\">assets:</span>precompile <span class=\"string\">cache:</span>clear RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>重启</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">service gitlab start</div><div class=\"line\">service nginx restart</div></pre></td></tr></table></figure>\n<p>Done!</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Gitlab-升级笔记\"><a href=\"#Gitlab-升级笔记\" class=\"headerlink\" title=\"Gitlab 升级笔记\"></a>Gitlab 升级笔记</h1><blockquote>\n<p>适用于使用源码安装的Gitlab</p>\n<p>GitLab Community Edition 8.3.2 fbb8b6e&gt;</p>\n</blockquote>\n<h4 id=\"0-Backup\"><a href=\"#0-Backup\" class=\"headerlink\" title=\"0. Backup\"></a>0. Backup</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd <span class=\"regexp\">/home/</span>git/gitlab</div><div class=\"line\">sudo -u git -H bundle exec rake <span class=\"string\">gitlab:</span><span class=\"string\">backup:</span>create RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>备份完成后会在<code>/home/git/gitlab/backup</code>文件夹下生成已时间戳命名的文件<code>1459217332_gitlab_backup.tar</code></p>\n<h4 id=\"1-Stop-server\"><a href=\"#1-Stop-server\" class=\"headerlink\" title=\"1. Stop server\"></a>1. Stop server</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo<span class=\"built_in\"> service </span>gitlab stop</div></pre></td></tr></table></figure>","more":"<h4 id=\"2-Run-GitLab-upgrade-tool\"><a href=\"#2-Run-GitLab-upgrade-tool\" class=\"headerlink\" title=\"2.Run GitLab upgrade tool\"></a>2.Run GitLab upgrade tool</h4><p>Please replace X.X.X with the <a href=\"https://packages.gitlab.com/gitlab/gitlab-ce\" target=\"_blank\" rel=\"noopener\">latest GitLab release</a>.</p>\n<p>GitLab 7.9 adds <code>nodejs</code> as a dependency. GitLab 7.6 adds <code>libkrb5-dev</code> as a dependency (installed by default on Ubuntu and OSX). GitLab 7.2 adds <code>pkg-config</code> and <code>cmake</code> as dependency. Please check the dependencies in the <a href=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/install/installation.md#1-packages-dependencies\" target=\"_blank\" rel=\"noopener\">installation guide</a>.</p>\n<figure class=\"highlight flix\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab</div><div class=\"line\">sudo -u git -H ruby -Ilib -e 'require <span class=\"string\">\"gitlab/upgrader\"</span>' -e '<span class=\"keyword\">class</span> Gitlab::Upgrader' -e '<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">latest_version_raw</span>' <span class=\"title\">-e</span> '\"<span class=\"title\">vX</span>.<span class=\"title\">X</span>.<span class=\"title\">X</span>\"' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">Gitlab</span></span>::Upgrader.new.execute'</div><div class=\"line\"></div><div class=\"line\"># to perform a non-interactive install (no user input required) you can add -y</div><div class=\"line\"># sudo -u git -H ruby -Ilib -e 'require <span class=\"string\">\"gitlab/upgrader\"</span>' -e '<span class=\"keyword\">class</span> Gitlab::Upgrader' -e '<span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">latest_version_raw</span>' <span class=\"title\">-e</span> '\"<span class=\"title\">vX</span>.<span class=\"title\">X</span>.<span class=\"title\">X</span>\"' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">end</span>' <span class=\"title\">-e</span> '<span class=\"title\">Gitlab</span></span>::Upgrader.new.execute' -- -y</div></pre></td></tr></table></figure>\n<p><em>小插曲：</em>执行命令时报错</p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">from /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span>:74:<span class=\"title\">in</span> `<span class=\"title\">upgrade</span>'</span></div><div class=\"line\"></div><div class=\"line\">    from /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span>:22:<span class=\"title\">in</span> `<span class=\"title\">execute</span>'</span></div><div class=\"line\"></div><div class=\"line\">    from -<span class=\"symbol\">e:</span><span class=\"number\">7</span>:in <span class=\"string\">`&lt;main&gt;'</span></div></pre></td></tr></table></figure>\n<p>解决办法</p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">Open /home/git/gitlab/<span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">gitlab</span>/<span class=\"title\">upgrader</span>.<span class=\"title\">rb</span> <span class=\"title\">in</span> <span class=\"title\">editor</span></span></div><div class=\"line\">Replace all <span class=\"comment\">#&#123;Gitlab.config.git.bin_path&#125; by git and save</span></div><div class=\"line\">Run upgrader.rb <span class=\"keyword\">as</span> usual</div></pre></td></tr></table></figure>\n<p>I have the same problem upgrading from 8.5.1 to 8.5.5. Replacing <code>Gitlab.config.git.bin_path</code> with <code>git</code> fixed it.<br>This is the search and replace command to run in vi: <code>%s/#{Gitlab.config.git.bin_path}/git/g</code></p>\n<h4 id=\"3-Start-application\"><a href=\"#3-Start-application\" class=\"headerlink\" title=\"3. Start application\"></a>3. Start application</h4><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo<span class=\"built_in\"> service </span>gitlab start</div><div class=\"line\">sudo<span class=\"built_in\"> service </span>nginx restart</div></pre></td></tr></table></figure>\n<h4 id=\"4-Check-application-status\"><a href=\"#4-Check-application-status\" class=\"headerlink\" title=\"4. Check application status\"></a>4. Check application status</h4><p>Check if GitLab and its dependencies are configured correctly:</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo -u git -H bundle exec rake gitlab:check <span class=\"attribute\">RAILS_ENV</span>=production</div></pre></td></tr></table></figure>\n<p>If all items are green, then congratulations upgrade is complete!</p>\n<h4 id=\"5-Upgrade-GitLab-Shell\"><a href=\"#5-Upgrade-GitLab-Shell\" class=\"headerlink\" title=\"5. Upgrade GitLab Shell\"></a>5. Upgrade GitLab Shell</h4><p>GitLab Shell might be outdated, running the commands below ensures you’re using a compatible version:</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab-<span class=\"keyword\">shell</span><span class=\"bash\"></span></div><div class=\"line\"><span class=\"bash\">sudo -u git -H git fetch</span></div><div class=\"line\"><span class=\"bash\">sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`</span></div></pre></td></tr></table></figure>\n<h4 id=\"One-line-upgrade-command\"><a href=\"#One-line-upgrade-command\" class=\"headerlink\" title=\"One line upgrade command\"></a>One line upgrade command</h4><p>You’ve read through the entire guide and probably already did all the steps one by one.<br>Below is a one line command with step 1 to 5 for the next time you upgrade.<br>Please replace X.X.X with the <a href=\"https://packages.gitlab.com/gitlab/gitlab-ce\" target=\"_blank\" rel=\"noopener\">latest GitLab release</a>.</p>\n<figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/git/gitlab; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service gitlab stop; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H ruby -Ilib -e <span class=\"string\">'require \"gitlab/upgrader\"'</span> -e <span class=\"string\">'class Gitlab::Upgrader'</span> -e <span class=\"string\">'def latest_version_raw'</span> -e <span class=\"string\">'\"vX.X.X\"'</span> -e <span class=\"string\">'end'</span> -e <span class=\"string\">'end'</span> -e <span class=\"string\">'Gitlab::Upgrader.new.execute'</span> -- -y; <span class=\"string\">\\</span></div><div class=\"line\">  cd /home/git/gitlab-shell; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H git fetch; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H git checkout v`cat /home/git/gitlab/GITLAB_SHELL_VERSION`; <span class=\"string\">\\</span></div><div class=\"line\">  cd /home/git/gitlab; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service gitlab start; <span class=\"string\">\\</span></div><div class=\"line\">  sudo service nginx restart; <span class=\"string\">\\</span></div><div class=\"line\">  sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>####Note:<br>阿里云服务器ruby源不稳定。换国内的源</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">gem sources --<span class=\"built_in\">add</span> http<span class=\"variable\">s:</span>//<span class=\"keyword\">ruby</span>.taobao.org/ --<span class=\"built_in\">remove</span> http<span class=\"variable\">s:</span>//rubygems.org/</div><div class=\"line\">gem sources -<span class=\"keyword\">l</span></div><div class=\"line\"># 请确保只有 <span class=\"keyword\">ruby</span>.taobao.org</div><div class=\"line\">gem install rails</div></pre></td></tr></table></figure>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"symbol\">sudo</span> -u git <span class=\"keyword\">bundle </span>install</div></pre></td></tr></table></figure>\n<p>安装完成之后 <code>update init script</code></p>\n<figure class=\"highlight crystal\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm /etc/init.d/gitlab</div><div class=\"line\">sudo cp <span class=\"class\"><span class=\"keyword\">lib</span>/<span class=\"title\">support</span>/<span class=\"title\">init</span>.<span class=\"title\">d</span>/<span class=\"title\">gitlab</span> /<span class=\"title\">etc</span>/<span class=\"title\">init</span>.<span class=\"title\">d</span>/<span class=\"title\">gitlab</span></span></div></pre></td></tr></table></figure>\n<p>升级是由于是从7.x 到8.x 样式变化很大，所以执行完后样式错乱。后来找了些文档才发现要重新生产asset文件。</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo -u git -H bundle exec rake <span class=\"string\">assets:</span>clean <span class=\"string\">assets:</span>precompile <span class=\"string\">cache:</span>clear RAILS_ENV=production</div></pre></td></tr></table></figure>\n<p>重启</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">service gitlab start</div><div class=\"line\">service nginx restart</div></pre></td></tr></table></figure>\n<p>Done!</p>"},{"title":"HHVM配置及简单性能测试","date":"2018-03-08T06:53:42.000Z","_content":"\n\n# HHVM配置及简单性能测试\n\n##### 机器配置如下：\n>OS: Ubuntu 16.04 xenial\n>Kernel: x86_64 Linux 4.13.0-36-generic\n>CPU: Intel Xeon CPU E3-1230 v3 @ 3.3GHz\n>RAM: 720MiB / 3001MiB\n##### PHP Version：\n>PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )\n>Copyright (c) 1997-2017 The PHP Group\n>Zend Engine v3.0.0, Copyright (c) 1998-2017 Zend Technologies\n    >    with Zend OPcache v7.0.22-0ubuntu0.16.04.1, Copyright (c) 1999-2017, by Zend Technologies\n\n##### hvm --version\n>HipHop VM 3.11.1 (rel)\n>Compiler: 3.11.1+dfsg-1ubuntu1\n>Repo schema: 2f678922fc70b326c82e56bedc2fc106c2faca61\n\n## 1、安装LNMP/LAMP服务器\n>性能测试对比使用，根据具体需要安装\n\n## 2、安装HHVM \n>[文档地址](https://www.digitalocean.com/community/tutorials/how-to-install-hhvm-with-nginx-on-ubuntu-14-04)\n\n### Installation:\n\nFor Ubuntu 14.04 there is an officially supported HHVM repository. To add this repository you have to import its GnuPG public keys with the command:\n`sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0x5a16e7281be7a449`\n\nAfter that you can safely install HHVM's repository with the command:\n`sudo add-apt-repository \"deb http://dl.hhvm.com/ubuntu $(lsb_release -sc) main\"`\n\nOnce you have the repository added you have to make apt, Ubuntu's software manager, aware that there are new packages which can be installed with it. This can be done by updating apt's cache with the command:\n`sudo apt-get update`\n\nFinally, you can install HHVM with the command:\n`sudo apt-get install hhvm`\n\nThe above command installs HHVM and starts it for the first time. To make sure HHVM starts and stops automatically with the Droplet, add HHVM to the default runlevels with the command:\n`sudo update-rc.d hhvm defaults`\n\n## 3、配置HHVM\n```shell\n; php options                                                                                \n; hhvm specific                                                                              \n\n;php-fpm使用的端口号是9000\n;端口号可sock 选用其中1个\nhhvm.server.port = 9003 \n;hhvm.server.file_socket=/var/run/hhvm/hhvm.sock\nhhvm.server.type = fastcgi                                                                   \nhhvm.server.default_document = index.php                                                     \nhhvm.server.source_root=/home/wwwroot/default                                                \n                                                                                             \nhhvm.log.use_log_file = false                                                                \nhhvm.log.use_syslog = true                                                                   \nhhvm.repo.central.path = /var/cache/hhvm/hhvm.hhbc \n```\n配置完成后启动\n`sudo service hhvm start`\n可以使用 `ps -ef | grep hhvm` 查看是否启动成功，`netstat -na | grep 9003` 查看端口是否正常监听\n\n## 4、配置nginx php配置\n>我这里使用的是lnmp,php配置文件是`/usr/local/nginx/conf/enable-php.conf`,其他同理\n```json\n        #location ~ \\.php$\n        location ~ \\.(hh|php)$ #添加.hh文件解析\n        {\n            try_files $uri =404;\n            fastcgi_keep_conn on;\n            #fastcgi_pass  unix:/tmp/php-cgi.sock; #php-fpm sock地址\n            #fastcgi_pass 127.0.0.1:9000; #php-fpm端口号\n            fastcgi_pass 127.0.0.1:9003; #hhvm端口号\n            fastcgi_index index.php;\n            include fastcgi.conf;\n        }\n```\nubuntu: `sudo service nginx restart` \ncentos: `/usr/sbin/nginx -s reload`\n`lnmp nginx restart` #如果使用的是lnmp重启nginx\n\n## 5、查看phpinfo是否配置成功\n在网站目录下新建`info.php`文件\n```php\n<?php\nphpinfo();\n?>\n```\n\n`sudo chown www-data: /usr/share/nginx/html/info.php`\n\n访问phpinfo `http://your_server_ip/info.php` 显示如下信息则配置成功\n![hhvm info](https://assets.digitalocean.com/articles/HHVM_ubuntu1404/HHVMinfo.png)\n\n## 6、附上简单的性能测试对比\n\n###HHVM 下\n```\n➜  default webbench-c 100 -t 60 http://wordpress.demo/ \nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 100 clients, running 60 sec.\n\nSpeed=3136 pages/min, 896948 bytes/sec.\nRequests: 3136 susceed, 0 failed.\n➜  default webbench -c 1000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 1000 clients, running 60 sec.\n\nSpeed=183728 pages/min, 967769 bytes/sec.\nRequests: 183728 susceed, 0 failed.\n➜  default webbench -c 10000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 10000 clients, running 60 sec.\n\nSpeed=428134 pages/min, 2219073 bytes/sec.\nRequests: 428116 susceed, 18 failed.\n```\n\n###php-fpm模式下\n\n```\n➜  default webbench -c 100 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 100 clients, running 60 sec.\n\nSpeed=625 pages/min, 178648 bytes/sec.\nRequests: 625 susceed, 0 failed.\n➜  default webbench -c 1000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 1000 clients, running 60 sec.\n\nSpeed=778 pages/min, 171166 bytes/sec.\nRequests: 778 susceed, 0 failed.\n\n➜  default webbench -c 10000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 10000 clients, running 60 sec.\n\nSpeed=288 pages/min, 46903 bytes/sec.\nRequests: 288 susceed, 0 failed.\n```\n\n默认配置下性能差别5-6倍","source":"_posts/hhvm.md","raw":"title: HHVM配置及简单性能测试\ndate: 2018-03-08 14:53:42\ncategories:\n- notes\ntags:\n- php\n---\n\n\n# HHVM配置及简单性能测试\n\n##### 机器配置如下：\n>OS: Ubuntu 16.04 xenial\n>Kernel: x86_64 Linux 4.13.0-36-generic\n>CPU: Intel Xeon CPU E3-1230 v3 @ 3.3GHz\n>RAM: 720MiB / 3001MiB\n##### PHP Version：\n>PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )\n>Copyright (c) 1997-2017 The PHP Group\n>Zend Engine v3.0.0, Copyright (c) 1998-2017 Zend Technologies\n    >    with Zend OPcache v7.0.22-0ubuntu0.16.04.1, Copyright (c) 1999-2017, by Zend Technologies\n\n##### hvm --version\n>HipHop VM 3.11.1 (rel)\n>Compiler: 3.11.1+dfsg-1ubuntu1\n>Repo schema: 2f678922fc70b326c82e56bedc2fc106c2faca61\n\n## 1、安装LNMP/LAMP服务器\n>性能测试对比使用，根据具体需要安装\n\n## 2、安装HHVM \n>[文档地址](https://www.digitalocean.com/community/tutorials/how-to-install-hhvm-with-nginx-on-ubuntu-14-04)\n\n### Installation:\n\nFor Ubuntu 14.04 there is an officially supported HHVM repository. To add this repository you have to import its GnuPG public keys with the command:\n`sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0x5a16e7281be7a449`\n\nAfter that you can safely install HHVM's repository with the command:\n`sudo add-apt-repository \"deb http://dl.hhvm.com/ubuntu $(lsb_release -sc) main\"`\n\nOnce you have the repository added you have to make apt, Ubuntu's software manager, aware that there are new packages which can be installed with it. This can be done by updating apt's cache with the command:\n`sudo apt-get update`\n\nFinally, you can install HHVM with the command:\n`sudo apt-get install hhvm`\n\nThe above command installs HHVM and starts it for the first time. To make sure HHVM starts and stops automatically with the Droplet, add HHVM to the default runlevels with the command:\n`sudo update-rc.d hhvm defaults`\n\n## 3、配置HHVM\n```shell\n; php options                                                                                \n; hhvm specific                                                                              \n\n;php-fpm使用的端口号是9000\n;端口号可sock 选用其中1个\nhhvm.server.port = 9003 \n;hhvm.server.file_socket=/var/run/hhvm/hhvm.sock\nhhvm.server.type = fastcgi                                                                   \nhhvm.server.default_document = index.php                                                     \nhhvm.server.source_root=/home/wwwroot/default                                                \n                                                                                             \nhhvm.log.use_log_file = false                                                                \nhhvm.log.use_syslog = true                                                                   \nhhvm.repo.central.path = /var/cache/hhvm/hhvm.hhbc \n```\n配置完成后启动\n`sudo service hhvm start`\n可以使用 `ps -ef | grep hhvm` 查看是否启动成功，`netstat -na | grep 9003` 查看端口是否正常监听\n\n## 4、配置nginx php配置\n>我这里使用的是lnmp,php配置文件是`/usr/local/nginx/conf/enable-php.conf`,其他同理\n```json\n        #location ~ \\.php$\n        location ~ \\.(hh|php)$ #添加.hh文件解析\n        {\n            try_files $uri =404;\n            fastcgi_keep_conn on;\n            #fastcgi_pass  unix:/tmp/php-cgi.sock; #php-fpm sock地址\n            #fastcgi_pass 127.0.0.1:9000; #php-fpm端口号\n            fastcgi_pass 127.0.0.1:9003; #hhvm端口号\n            fastcgi_index index.php;\n            include fastcgi.conf;\n        }\n```\nubuntu: `sudo service nginx restart` \ncentos: `/usr/sbin/nginx -s reload`\n`lnmp nginx restart` #如果使用的是lnmp重启nginx\n\n## 5、查看phpinfo是否配置成功\n在网站目录下新建`info.php`文件\n```php\n<?php\nphpinfo();\n?>\n```\n\n`sudo chown www-data: /usr/share/nginx/html/info.php`\n\n访问phpinfo `http://your_server_ip/info.php` 显示如下信息则配置成功\n![hhvm info](https://assets.digitalocean.com/articles/HHVM_ubuntu1404/HHVMinfo.png)\n\n## 6、附上简单的性能测试对比\n\n###HHVM 下\n```\n➜  default webbench-c 100 -t 60 http://wordpress.demo/ \nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 100 clients, running 60 sec.\n\nSpeed=3136 pages/min, 896948 bytes/sec.\nRequests: 3136 susceed, 0 failed.\n➜  default webbench -c 1000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 1000 clients, running 60 sec.\n\nSpeed=183728 pages/min, 967769 bytes/sec.\nRequests: 183728 susceed, 0 failed.\n➜  default webbench -c 10000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 10000 clients, running 60 sec.\n\nSpeed=428134 pages/min, 2219073 bytes/sec.\nRequests: 428116 susceed, 18 failed.\n```\n\n###php-fpm模式下\n\n```\n➜  default webbench -c 100 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 100 clients, running 60 sec.\n\nSpeed=625 pages/min, 178648 bytes/sec.\nRequests: 625 susceed, 0 failed.\n➜  default webbench -c 1000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 1000 clients, running 60 sec.\n\nSpeed=778 pages/min, 171166 bytes/sec.\nRequests: 778 susceed, 0 failed.\n\n➜  default webbench -c 10000 -t 60 http://wordpress.demo/\nWebbench - Simple Web Benchmark 1.5\nCopyright (c) Radim Kolar 1997-2004, GPL Open Source Software.\n\nRequest:\nGET / HTTP/1.0\nUser-Agent: WebBench 1.5\nHost: wordpress.demo\n\n\nRuning info: 10000 clients, running 60 sec.\n\nSpeed=288 pages/min, 46903 bytes/sec.\nRequests: 288 susceed, 0 failed.\n```\n\n默认配置下性能差别5-6倍","slug":"hhvm","published":1,"updated":"2018-03-09T01:57:16.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjejamqyw0007wctxyjs6dmgd","content":"<h1 id=\"HHVM配置及简单性能测试\"><a href=\"#HHVM配置及简单性能测试\" class=\"headerlink\" title=\"HHVM配置及简单性能测试\"></a>HHVM配置及简单性能测试</h1><h5 id=\"机器配置如下：\"><a href=\"#机器配置如下：\" class=\"headerlink\" title=\"机器配置如下：\"></a>机器配置如下：</h5><blockquote>\n<p>OS: Ubuntu 16.04 xenial<br>Kernel: x86_64 Linux 4.13.0-36-generic<br>CPU: Intel Xeon CPU E3-1230 v3 @ 3.3GHz<br>RAM: 720MiB / 3001MiB</p>\n<h5 id=\"PHP-Version：\"><a href=\"#PHP-Version：\" class=\"headerlink\" title=\"PHP Version：\"></a>PHP Version：</h5><p>PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )<br>Copyright (c) 1997-2017 The PHP Group<br>Zend Engine v3.0.0, Copyright (c) 1998-2017 Zend Technologies<br>   with Zend OPcache v7.0.22-0ubuntu0.16.04.1, Copyright (c) 1999-2017, by Zend Technologies</p>\n</blockquote>\n<h5 id=\"hvm-–version\"><a href=\"#hvm-–version\" class=\"headerlink\" title=\"hvm –version\"></a>hvm –version</h5><blockquote>\n<p>HipHop VM 3.11.1 (rel)<br>Compiler: 3.11.1+dfsg-1ubuntu1<br>Repo schema: 2f678922fc70b326c82e56bedc2fc106c2faca61</p>\n</blockquote>\n<h2 id=\"1、安装LNMP-LAMP服务器\"><a href=\"#1、安装LNMP-LAMP服务器\" class=\"headerlink\" title=\"1、安装LNMP/LAMP服务器\"></a>1、安装LNMP/LAMP服务器</h2><blockquote>\n<p>性能测试对比使用，根据具体需要安装</p>\n</blockquote>\n<h2 id=\"2、安装HHVM\"><a href=\"#2、安装HHVM\" class=\"headerlink\" title=\"2、安装HHVM\"></a>2、安装HHVM</h2><blockquote>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-hhvm-with-nginx-on-ubuntu-14-04\" target=\"_blank\" rel=\"noopener\">文档地址</a></p>\n</blockquote>\n<h3 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation:\"></a>Installation:</h3><p>For Ubuntu 14.04 there is an officially supported HHVM repository. To add this repository you have to import its GnuPG public keys with the command:<br><code>sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0x5a16e7281be7a449</code></p>\n<p>After that you can safely install HHVM’s repository with the command:<br><code>sudo add-apt-repository &quot;deb http://dl.hhvm.com/ubuntu $(lsb_release -sc) main&quot;</code></p>\n<p>Once you have the repository added you have to make apt, Ubuntu’s software manager, aware that there are new packages which can be installed with it. This can be done by updating apt’s cache with the command:<br><code>sudo apt-get update</code></p>\n<p>Finally, you can install HHVM with the command:<br><code>sudo apt-get install hhvm</code></p>\n<p>The above command installs HHVM and starts it for the first time. To make sure HHVM starts and stops automatically with the Droplet, add HHVM to the default runlevels with the command:<br><code>sudo update-rc.d hhvm defaults</code></p>\n<h2 id=\"3、配置HHVM\"><a href=\"#3、配置HHVM\" class=\"headerlink\" title=\"3、配置HHVM\"></a>3、配置HHVM</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">; php options                                                                                </div><div class=\"line\">; hhvm specific                                                                              </div><div class=\"line\"></div><div class=\"line\">;php-fpm使用的端口号是9000</div><div class=\"line\">;端口号可sock 选用其中1个</div><div class=\"line\">hhvm.server.port = 9003 </div><div class=\"line\">;hhvm.server.file_socket=/var/run/hhvm/hhvm.sock</div><div class=\"line\">hhvm.server.type = fastcgi                                                                   </div><div class=\"line\">hhvm.server.default_document = index.php                                                     </div><div class=\"line\">hhvm.server.source_root=/home/wwwroot/default                                                </div><div class=\"line\">                                                                                             </div><div class=\"line\">hhvm.log.use_log_file = false                                                                </div><div class=\"line\">hhvm.log.use_syslog = true                                                                   </div><div class=\"line\">hhvm.repo.central.path = /var/cache/hhvm/hhvm.hhbc</div></pre></td></tr></table></figure>\n<p>配置完成后启动<br><code>sudo service hhvm start</code><br>可以使用 <code>ps -ef | grep hhvm</code> 查看是否启动成功，<code>netstat -na | grep 9003</code> 查看端口是否正常监听</p>\n<h2 id=\"4、配置nginx-php配置\"><a href=\"#4、配置nginx-php配置\" class=\"headerlink\" title=\"4、配置nginx php配置\"></a>4、配置nginx php配置</h2><blockquote>\n<p>我这里使用的是lnmp,php配置文件是<code>/usr/local/nginx/conf/enable-php.conf</code>,其他同理<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">#location ~ \\.php$</div><div class=\"line\">location ~ \\.(hh|php)$ #添加.hh文件解析</div><div class=\"line\">&#123;</div><div class=\"line\">    try_files $uri =404;</div><div class=\"line\">    fastcgi_keep_conn on;</div><div class=\"line\">    #fastcgi_pass  unix:/tmp/php-cgi.sock; #php-fpm sock地址</div><div class=\"line\">    #fastcgi_pass 127.0.0.1:9000; #php-fpm端口号</div><div class=\"line\">    fastcgi_pass 127.0.0.1:9003; #hhvm端口号</div><div class=\"line\">    fastcgi_index index.php;</div><div class=\"line\">    include fastcgi.conf;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n</blockquote>\n<p>ubuntu: <code>sudo service nginx restart</code><br>centos: <code>/usr/sbin/nginx -s reload</code><br><code>lnmp nginx restart</code> #如果使用的是lnmp重启nginx</p>\n<h2 id=\"5、查看phpinfo是否配置成功\"><a href=\"#5、查看phpinfo是否配置成功\" class=\"headerlink\" title=\"5、查看phpinfo是否配置成功\"></a>5、查看phpinfo是否配置成功</h2><p>在网站目录下新建<code>info.php</code>文件<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">phpinfo();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p><code>sudo chown www-data: /usr/share/nginx/html/info.php</code></p>\n<p>访问phpinfo <code>http://your_server_ip/info.php</code> 显示如下信息则配置成功<br><img src=\"https://assets.digitalocean.com/articles/HHVM_ubuntu1404/HHVMinfo.png\" alt=\"hhvm info\"></p>\n<h2 id=\"6、附上简单的性能测试对比\"><a href=\"#6、附上简单的性能测试对比\" class=\"headerlink\" title=\"6、附上简单的性能测试对比\"></a>6、附上简单的性能测试对比</h2><p>###HHVM 下<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench-c <span class=\"number\">100</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/ </span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">100</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">3136</span> pages<span class=\"regexp\">/min, 896948 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">3136</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">1000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">1000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">183728</span> pages<span class=\"regexp\">/min, 967769 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">183728</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">10000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">10000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">428134</span> pages<span class=\"regexp\">/min, 2219073 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">428116</span> susceed, <span class=\"number\">18</span> failed.</div></pre></td></tr></table></figure></p>\n<p>###php-fpm模式下</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div></pre></td><td class=\"code\"><pre><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">100</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">100</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">625</span> pages<span class=\"regexp\">/min, 178648 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">625</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">1000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">1000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">778</span> pages<span class=\"regexp\">/min, 171166 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">778</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\"></div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">10000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">10000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">288</span> pages<span class=\"regexp\">/min, 46903 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">288</span> susceed, <span class=\"number\">0</span> failed.</div></pre></td></tr></table></figure>\n<p>默认配置下性能差别5-6倍</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"HHVM配置及简单性能测试\"><a href=\"#HHVM配置及简单性能测试\" class=\"headerlink\" title=\"HHVM配置及简单性能测试\"></a>HHVM配置及简单性能测试</h1><h5 id=\"机器配置如下：\"><a href=\"#机器配置如下：\" class=\"headerlink\" title=\"机器配置如下：\"></a>机器配置如下：</h5><blockquote>\n<p>OS: Ubuntu 16.04 xenial<br>Kernel: x86_64 Linux 4.13.0-36-generic<br>CPU: Intel Xeon CPU E3-1230 v3 @ 3.3GHz<br>RAM: 720MiB / 3001MiB</p>\n<h5 id=\"PHP-Version：\"><a href=\"#PHP-Version：\" class=\"headerlink\" title=\"PHP Version：\"></a>PHP Version：</h5><p>PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )<br>Copyright (c) 1997-2017 The PHP Group<br>Zend Engine v3.0.0, Copyright (c) 1998-2017 Zend Technologies<br>   with Zend OPcache v7.0.22-0ubuntu0.16.04.1, Copyright (c) 1999-2017, by Zend Technologies</p>\n</blockquote>\n<h5 id=\"hvm-–version\"><a href=\"#hvm-–version\" class=\"headerlink\" title=\"hvm –version\"></a>hvm –version</h5><blockquote>\n<p>HipHop VM 3.11.1 (rel)<br>Compiler: 3.11.1+dfsg-1ubuntu1<br>Repo schema: 2f678922fc70b326c82e56bedc2fc106c2faca61</p>\n</blockquote>\n<h2 id=\"1、安装LNMP-LAMP服务器\"><a href=\"#1、安装LNMP-LAMP服务器\" class=\"headerlink\" title=\"1、安装LNMP/LAMP服务器\"></a>1、安装LNMP/LAMP服务器</h2><blockquote>\n<p>性能测试对比使用，根据具体需要安装</p>\n</blockquote>\n<h2 id=\"2、安装HHVM\"><a href=\"#2、安装HHVM\" class=\"headerlink\" title=\"2、安装HHVM\"></a>2、安装HHVM</h2><blockquote>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-install-hhvm-with-nginx-on-ubuntu-14-04\" target=\"_blank\" rel=\"noopener\">文档地址</a></p>\n</blockquote>\n<h3 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation:\"></a>Installation:</h3><p>For Ubuntu 14.04 there is an officially supported HHVM repository. To add this repository you have to import its GnuPG public keys with the command:<br><code>sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0x5a16e7281be7a449</code></p>\n<p>After that you can safely install HHVM’s repository with the command:<br><code>sudo add-apt-repository &quot;deb http://dl.hhvm.com/ubuntu $(lsb_release -sc) main&quot;</code></p>\n<p>Once you have the repository added you have to make apt, Ubuntu’s software manager, aware that there are new packages which can be installed with it. This can be done by updating apt’s cache with the command:<br><code>sudo apt-get update</code></p>\n<p>Finally, you can install HHVM with the command:<br><code>sudo apt-get install hhvm</code></p>\n<p>The above command installs HHVM and starts it for the first time. To make sure HHVM starts and stops automatically with the Droplet, add HHVM to the default runlevels with the command:<br><code>sudo update-rc.d hhvm defaults</code></p>\n<h2 id=\"3、配置HHVM\"><a href=\"#3、配置HHVM\" class=\"headerlink\" title=\"3、配置HHVM\"></a>3、配置HHVM</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">; php options                                                                                </div><div class=\"line\">; hhvm specific                                                                              </div><div class=\"line\"></div><div class=\"line\">;php-fpm使用的端口号是9000</div><div class=\"line\">;端口号可sock 选用其中1个</div><div class=\"line\">hhvm.server.port = 9003 </div><div class=\"line\">;hhvm.server.file_socket=/var/run/hhvm/hhvm.sock</div><div class=\"line\">hhvm.server.type = fastcgi                                                                   </div><div class=\"line\">hhvm.server.default_document = index.php                                                     </div><div class=\"line\">hhvm.server.source_root=/home/wwwroot/default                                                </div><div class=\"line\">                                                                                             </div><div class=\"line\">hhvm.log.use_log_file = false                                                                </div><div class=\"line\">hhvm.log.use_syslog = true                                                                   </div><div class=\"line\">hhvm.repo.central.path = /var/cache/hhvm/hhvm.hhbc</div></pre></td></tr></table></figure>\n<p>配置完成后启动<br><code>sudo service hhvm start</code><br>可以使用 <code>ps -ef | grep hhvm</code> 查看是否启动成功，<code>netstat -na | grep 9003</code> 查看端口是否正常监听</p>\n<h2 id=\"4、配置nginx-php配置\"><a href=\"#4、配置nginx-php配置\" class=\"headerlink\" title=\"4、配置nginx php配置\"></a>4、配置nginx php配置</h2><blockquote>\n<p>我这里使用的是lnmp,php配置文件是<code>/usr/local/nginx/conf/enable-php.conf</code>,其他同理<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">#location ~ \\.php$</div><div class=\"line\">location ~ \\.(hh|php)$ #添加.hh文件解析</div><div class=\"line\">&#123;</div><div class=\"line\">    try_files $uri =404;</div><div class=\"line\">    fastcgi_keep_conn on;</div><div class=\"line\">    #fastcgi_pass  unix:/tmp/php-cgi.sock; #php-fpm sock地址</div><div class=\"line\">    #fastcgi_pass 127.0.0.1:9000; #php-fpm端口号</div><div class=\"line\">    fastcgi_pass 127.0.0.1:9003; #hhvm端口号</div><div class=\"line\">    fastcgi_index index.php;</div><div class=\"line\">    include fastcgi.conf;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n</blockquote>\n<p>ubuntu: <code>sudo service nginx restart</code><br>centos: <code>/usr/sbin/nginx -s reload</code><br><code>lnmp nginx restart</code> #如果使用的是lnmp重启nginx</p>\n<h2 id=\"5、查看phpinfo是否配置成功\"><a href=\"#5、查看phpinfo是否配置成功\" class=\"headerlink\" title=\"5、查看phpinfo是否配置成功\"></a>5、查看phpinfo是否配置成功</h2><p>在网站目录下新建<code>info.php</code>文件<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">phpinfo();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p><code>sudo chown www-data: /usr/share/nginx/html/info.php</code></p>\n<p>访问phpinfo <code>http://your_server_ip/info.php</code> 显示如下信息则配置成功<br><img src=\"https://assets.digitalocean.com/articles/HHVM_ubuntu1404/HHVMinfo.png\" alt=\"hhvm info\"></p>\n<h2 id=\"6、附上简单的性能测试对比\"><a href=\"#6、附上简单的性能测试对比\" class=\"headerlink\" title=\"6、附上简单的性能测试对比\"></a>6、附上简单的性能测试对比</h2><p>###HHVM 下<br><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench-c <span class=\"number\">100</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/ </span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">100</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">3136</span> pages<span class=\"regexp\">/min, 896948 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">3136</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">1000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">1000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">183728</span> pages<span class=\"regexp\">/min, 967769 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">183728</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">10000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">10000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">428134</span> pages<span class=\"regexp\">/min, 2219073 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">428116</span> susceed, <span class=\"number\">18</span> failed.</div></pre></td></tr></table></figure></p>\n<p>###php-fpm模式下</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div></pre></td><td class=\"code\"><pre><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">100</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">100</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">625</span> pages<span class=\"regexp\">/min, 178648 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">625</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">1000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">1000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">778</span> pages<span class=\"regexp\">/min, 171166 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">778</span> susceed, <span class=\"number\">0</span> failed.</div><div class=\"line\"></div><div class=\"line\">➜  <span class=\"keyword\">default</span> webbench -c <span class=\"number\">10000</span> -t <span class=\"number\">60</span> <span class=\"string\">http:</span><span class=\"comment\">//wordpress.demo/</span></div><div class=\"line\">Webbench - Simple Web Benchmark <span class=\"number\">1.5</span></div><div class=\"line\">Copyright (c) Radim Kolar <span class=\"number\">1997</span><span class=\"number\">-2004</span>, GPL Open Source Software.</div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">Request:</span></div><div class=\"line\">GET <span class=\"regexp\">/ HTTP/</span><span class=\"number\">1.0</span></div><div class=\"line\">User-<span class=\"string\">Agent:</span> WebBench <span class=\"number\">1.5</span></div><div class=\"line\"><span class=\"string\">Host:</span> wordpress.demo</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">Runing <span class=\"string\">info:</span> <span class=\"number\">10000</span> clients, running <span class=\"number\">60</span> sec.</div><div class=\"line\"></div><div class=\"line\">Speed=<span class=\"number\">288</span> pages<span class=\"regexp\">/min, 46903 bytes/</span>sec.</div><div class=\"line\"><span class=\"string\">Requests:</span> <span class=\"number\">288</span> susceed, <span class=\"number\">0</span> failed.</div></pre></td></tr></table></figure>\n<p>默认配置下性能差别5-6倍</p>\n"},{"title":"网易云音乐爬虫 PHP版本","date":"2017-07-31T02:07:00.000Z","_content":"\n# 网易云音乐爬虫 - 爬取评论 - PHP\n\n#### 1、拼接url\n```php\n/**\n* 生成接口url\n*/\nfunction crypt_api($song_id, $offset){\n    $url = \"http://music.163.com/weapi/v1/resource/comments/R_SO_4_{$song_id}/?csrf_token=\";\n    $first_param = \"{rid:\\\"\\\", offset:\\\"{$offset}\\\", total:\\\"true\\\", limit:\\\"20\\\", csrf_token:\\\"\\\"}\"; \n    $forth_param = \"0CoJUm6Qyw8W8jud\";\n    $params = get_params($first_param, $forth_param);\n    $encSecKey = get_encSecKey();\n    $data = array(\n        \"params\"=> $params,\n        \"encSecKey\"=> $encSecKey\n    );\n    return array($url, $data);\n}\n```\n#### 2、生成接口的params参数\n```php\n/*\n* 生成接口参数\n*/\nfunction get_params($first_param, $forth_param){\n    $iv = \"0102030405060708\";\n    $first_key = $forth_param;\n    $second_key = 'FFFFFFFFFFFFFFFF';\n    $encryptObj = new MagicCrypt();\n    $h_encText = $encryptObj->encrypt($first_param,$first_key,$iv);\n\t$h_encText = $encryptObj->encrypt($h_encText,$second_key,$iv);\n    return $h_encText;\n}\n\nfunction get_encSecKey(){\n    $encSecKey = \"257348aecb5e556c066de214e531faadd1c55d814f9be95fd06d6bff9f4c7a41f831f6394d5a3fd2e3881736d94a02ca919d952872e7d0a50ebfa1769a7a62d512f5f1ca21aec60bc3819a9c3ffca5eca9a0dba6d6f7249b06f5965ecfff3695b54e1c28f3f624750ed39e7de08fc8493242e26dbc4484a01c76f739e135637c\";\n    return $encSecKey;\n}\n```\n\n#### 3、AES 加密解密\n```php\nclass MagicCrypt {\n    /**\n    * @param $encryptStr 需要加密的字符串\n    * @param $encryptKey 加密的key\n    * @param $iv 向量，增加加密的安全性\n    */\n    public function encrypt($encryptStr,$encryptKey,$iv) {\n        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, $iv);\n        mcrypt_generic_init($module, $encryptKey, $iv);\n        //Padding\n        $block = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);\n        $pad = $block - (strlen($encryptStr) % $block); //Compute how many characters need to pad\n        $encryptStr .= str_repeat(chr($pad), $pad); // After pad, the str length must be equal to block or its integer multiples\n        //encrypt\n        $encrypted = mcrypt_generic($module, $encryptStr);\n        mcrypt_generic_deinit($module);\n        mcrypt_module_close($module);\n        return base64_encode($encrypted);\n    }\n     /**\n    * @param $encryptStr 需要解密的字符串\n    * @param $encryptKey 加密时使用的key\n    * @param $iv 加密时使用的向量\n    */\n    public function decrypt($encryptStr,$encryptKey,$iv) {\n        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, $iv);\n        mcrypt_generic_init($module, $encryptKey, $iv);\n        $encryptedData = base64_decode($encryptStr);\n        $encryptedData = mdecrypt_generic($module, $encryptedData);\n        return $encryptedData;\n    }\n}\n```\n\n#### 4、curlPost函数\n```php\nfunction _curlPost($url, $curlPost, $cookie_str = '', $header_ary = array()){\n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_HEADER, false);\n\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($curl, CURLOPT_POST, true);\n    curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost);\n\tif (substr($url,0,5)=='https') {\n        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);\n    }\n    if ($cookie_str) {\n        curl_setopt($curl, CURLOPT_COOKIE, $cookie_str);\n    }\n    if ($header_ary) {\n        curl_setopt($curl, CURLOPT_HTTPHEADER, $header_ary);\n    }\n    $return_str = curl_exec($curl);\n    curl_close($curl);\n    return $return_str;\n}\n```\n#### 5、请求数据\n```php\n//http://music.163.com/#/song?id=32507038\nget_comment(32507038);\n\n/**\n* 获取评论信息\n* @param $song_id 歌曲id\n*/\nfunction get_comment($song_id){\n    $offset = 0;\n    $has_more = true;\n    while ($has_more) {\n        $has_more = false;\n        list($url, $data) = crypt_api($song_id, $offset);\n        $headers = array(\n            'Referer'=>'http://music.163.com/',\n            'Cookie'=> 'appver=1.5.0.75771;MUSIC_U=e954e2600e0c1ecfadbd06b365a3950f2fbcf4e9ffcf7e2733a8dda4202263671b4513c5c9ddb66f1b44c7a29488a6fff4ade6dff45127b3e9fc49f25c8de500d8f960110ee0022abf122d59fa1ed6a2;'\n            );\n        $result = _curlPost($url,http_build_query($data),'',$headers);\n        if ($result) {\n            $data = json_decode($result);\n            if ($data) {\n                if ($data->code == 200) {\n                    if ($data->comments) {\n                        $comments = json_decode(json_encode($data->comments),true);\n                        //保存评论信息\n                        save_comments($song_id,$comments);\n                    }\n                    $has_more = $data->more == 'true';\n                    //跟get_params里面的limit参数一致\n                    $offset += 20;\n                }else{\n                    handleError(\"data['code']:$data[code]\");\t\n                }\n            }else{\n                handleError(\"json_decode error\");\n            }\n        }else{\n            handleError(\"_curlPost result:null\");\n        }\n        sleep(1);\n    }\n}\n```\n\n参考:\n\n 1. [php实现AES/CBC/PKCS5Padding加密解密（又叫：对称加密）](http://www.cnblogs.com/ygyg/p/5686258.html)\n 2. [https://github.com/wenhaoliang/netease-music-spider](https://github.com/wenhaoliang/netease-music-spider)\n 3. [http://blog.csdn.net/Ciiiiiing/article/details/62434438](http://blog.csdn.net/Ciiiiiing/article/details/62434438)\n","source":"_posts/neteasy_music_spider.md","raw":"title: 网易云音乐爬虫 PHP版本\ndate: 2017-07-31 10:07\ncategories:\n- notes\ntags:\n- netease\n- php\n---\n\n# 网易云音乐爬虫 - 爬取评论 - PHP\n\n#### 1、拼接url\n```php\n/**\n* 生成接口url\n*/\nfunction crypt_api($song_id, $offset){\n    $url = \"http://music.163.com/weapi/v1/resource/comments/R_SO_4_{$song_id}/?csrf_token=\";\n    $first_param = \"{rid:\\\"\\\", offset:\\\"{$offset}\\\", total:\\\"true\\\", limit:\\\"20\\\", csrf_token:\\\"\\\"}\"; \n    $forth_param = \"0CoJUm6Qyw8W8jud\";\n    $params = get_params($first_param, $forth_param);\n    $encSecKey = get_encSecKey();\n    $data = array(\n        \"params\"=> $params,\n        \"encSecKey\"=> $encSecKey\n    );\n    return array($url, $data);\n}\n```\n#### 2、生成接口的params参数\n```php\n/*\n* 生成接口参数\n*/\nfunction get_params($first_param, $forth_param){\n    $iv = \"0102030405060708\";\n    $first_key = $forth_param;\n    $second_key = 'FFFFFFFFFFFFFFFF';\n    $encryptObj = new MagicCrypt();\n    $h_encText = $encryptObj->encrypt($first_param,$first_key,$iv);\n\t$h_encText = $encryptObj->encrypt($h_encText,$second_key,$iv);\n    return $h_encText;\n}\n\nfunction get_encSecKey(){\n    $encSecKey = \"257348aecb5e556c066de214e531faadd1c55d814f9be95fd06d6bff9f4c7a41f831f6394d5a3fd2e3881736d94a02ca919d952872e7d0a50ebfa1769a7a62d512f5f1ca21aec60bc3819a9c3ffca5eca9a0dba6d6f7249b06f5965ecfff3695b54e1c28f3f624750ed39e7de08fc8493242e26dbc4484a01c76f739e135637c\";\n    return $encSecKey;\n}\n```\n\n#### 3、AES 加密解密\n```php\nclass MagicCrypt {\n    /**\n    * @param $encryptStr 需要加密的字符串\n    * @param $encryptKey 加密的key\n    * @param $iv 向量，增加加密的安全性\n    */\n    public function encrypt($encryptStr,$encryptKey,$iv) {\n        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, $iv);\n        mcrypt_generic_init($module, $encryptKey, $iv);\n        //Padding\n        $block = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);\n        $pad = $block - (strlen($encryptStr) % $block); //Compute how many characters need to pad\n        $encryptStr .= str_repeat(chr($pad), $pad); // After pad, the str length must be equal to block or its integer multiples\n        //encrypt\n        $encrypted = mcrypt_generic($module, $encryptStr);\n        mcrypt_generic_deinit($module);\n        mcrypt_module_close($module);\n        return base64_encode($encrypted);\n    }\n     /**\n    * @param $encryptStr 需要解密的字符串\n    * @param $encryptKey 加密时使用的key\n    * @param $iv 加密时使用的向量\n    */\n    public function decrypt($encryptStr,$encryptKey,$iv) {\n        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, $iv);\n        mcrypt_generic_init($module, $encryptKey, $iv);\n        $encryptedData = base64_decode($encryptStr);\n        $encryptedData = mdecrypt_generic($module, $encryptedData);\n        return $encryptedData;\n    }\n}\n```\n\n#### 4、curlPost函数\n```php\nfunction _curlPost($url, $curlPost, $cookie_str = '', $header_ary = array()){\n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_HEADER, false);\n\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($curl, CURLOPT_POST, true);\n    curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost);\n\tif (substr($url,0,5)=='https') {\n        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);\n    }\n    if ($cookie_str) {\n        curl_setopt($curl, CURLOPT_COOKIE, $cookie_str);\n    }\n    if ($header_ary) {\n        curl_setopt($curl, CURLOPT_HTTPHEADER, $header_ary);\n    }\n    $return_str = curl_exec($curl);\n    curl_close($curl);\n    return $return_str;\n}\n```\n#### 5、请求数据\n```php\n//http://music.163.com/#/song?id=32507038\nget_comment(32507038);\n\n/**\n* 获取评论信息\n* @param $song_id 歌曲id\n*/\nfunction get_comment($song_id){\n    $offset = 0;\n    $has_more = true;\n    while ($has_more) {\n        $has_more = false;\n        list($url, $data) = crypt_api($song_id, $offset);\n        $headers = array(\n            'Referer'=>'http://music.163.com/',\n            'Cookie'=> 'appver=1.5.0.75771;MUSIC_U=e954e2600e0c1ecfadbd06b365a3950f2fbcf4e9ffcf7e2733a8dda4202263671b4513c5c9ddb66f1b44c7a29488a6fff4ade6dff45127b3e9fc49f25c8de500d8f960110ee0022abf122d59fa1ed6a2;'\n            );\n        $result = _curlPost($url,http_build_query($data),'',$headers);\n        if ($result) {\n            $data = json_decode($result);\n            if ($data) {\n                if ($data->code == 200) {\n                    if ($data->comments) {\n                        $comments = json_decode(json_encode($data->comments),true);\n                        //保存评论信息\n                        save_comments($song_id,$comments);\n                    }\n                    $has_more = $data->more == 'true';\n                    //跟get_params里面的limit参数一致\n                    $offset += 20;\n                }else{\n                    handleError(\"data['code']:$data[code]\");\t\n                }\n            }else{\n                handleError(\"json_decode error\");\n            }\n        }else{\n            handleError(\"_curlPost result:null\");\n        }\n        sleep(1);\n    }\n}\n```\n\n参考:\n\n 1. [php实现AES/CBC/PKCS5Padding加密解密（又叫：对称加密）](http://www.cnblogs.com/ygyg/p/5686258.html)\n 2. [https://github.com/wenhaoliang/netease-music-spider](https://github.com/wenhaoliang/netease-music-spider)\n 3. [http://blog.csdn.net/Ciiiiiing/article/details/62434438](http://blog.csdn.net/Ciiiiiing/article/details/62434438)\n","slug":"neteasy_music_spider","published":1,"updated":"2018-02-05T05:51:34.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjejamqyx0008wctxfpmlkek9","content":"<h1 id=\"网易云音乐爬虫-爬取评论-PHP\"><a href=\"#网易云音乐爬虫-爬取评论-PHP\" class=\"headerlink\" title=\"网易云音乐爬虫 - 爬取评论 - PHP\"></a>网易云音乐爬虫 - 爬取评论 - PHP</h1><h4 id=\"1、拼接url\"><a href=\"#1、拼接url\" class=\"headerlink\" title=\"1、拼接url\"></a>1、拼接url</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">* 生成接口url</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">crypt_api</span><span class=\"params\">($song_id, $offset)</span></span>&#123;</div><div class=\"line\">    $url = <span class=\"string\">\"http://music.163.com/weapi/v1/resource/comments/R_SO_4_&#123;$song_id&#125;/?csrf_token=\"</span>;</div><div class=\"line\">    $first_param = <span class=\"string\">\"&#123;rid:\\\"\\\", offset:\\\"&#123;$offset&#125;\\\", total:\\\"true\\\", limit:\\\"20\\\", csrf_token:\\\"\\\"&#125;\"</span>; </div><div class=\"line\">    $forth_param = <span class=\"string\">\"0CoJUm6Qyw8W8jud\"</span>;</div><div class=\"line\">    $params = get_params($first_param, $forth_param);</div><div class=\"line\">    $encSecKey = get_encSecKey();</div><div class=\"line\">    $data = <span class=\"keyword\">array</span>(</div><div class=\"line\">        <span class=\"string\">\"params\"</span>=&gt; $params,</div><div class=\"line\">        <span class=\"string\">\"encSecKey\"</span>=&gt; $encSecKey</div><div class=\"line\">    );</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">array</span>($url, $data);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"2、生成接口的params参数\"><a href=\"#2、生成接口的params参数\" class=\"headerlink\" title=\"2、生成接口的params参数\"></a>2、生成接口的params参数</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/*</span></div><div class=\"line\"><span class=\"comment\">* 生成接口参数</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_params</span><span class=\"params\">($first_param, $forth_param)</span></span>&#123;</div><div class=\"line\">    $iv = <span class=\"string\">\"0102030405060708\"</span>;</div><div class=\"line\">    $first_key = $forth_param;</div><div class=\"line\">    $second_key = <span class=\"string\">'FFFFFFFFFFFFFFFF'</span>;</div><div class=\"line\">    $encryptObj = <span class=\"keyword\">new</span> MagicCrypt();</div><div class=\"line\">    $h_encText = $encryptObj-&gt;encrypt($first_param,$first_key,$iv);</div><div class=\"line\">\t$h_encText = $encryptObj-&gt;encrypt($h_encText,$second_key,$iv);</div><div class=\"line\">    <span class=\"keyword\">return</span> $h_encText;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_encSecKey</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    $encSecKey = <span class=\"string\">\"257348aecb5e556c066de214e531faadd1c55d814f9be95fd06d6bff9f4c7a41f831f6394d5a3fd2e3881736d94a02ca919d952872e7d0a50ebfa1769a7a62d512f5f1ca21aec60bc3819a9c3ffca5eca9a0dba6d6f7249b06f5965ecfff3695b54e1c28f3f624750ed39e7de08fc8493242e26dbc4484a01c76f739e135637c\"</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> $encSecKey;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3、AES-加密解密\"><a href=\"#3、AES-加密解密\" class=\"headerlink\" title=\"3、AES 加密解密\"></a>3、AES 加密解密</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MagicCrypt</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptStr 需要加密的字符串</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptKey 加密的key</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $iv 向量，增加加密的安全性</span></div><div class=\"line\"><span class=\"comment\">    */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encrypt</span><span class=\"params\">($encryptStr,$encryptKey,$iv)</span> </span>&#123;</div><div class=\"line\">        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class=\"string\">''</span>, MCRYPT_MODE_CBC, $iv);</div><div class=\"line\">        mcrypt_generic_init($module, $encryptKey, $iv);</div><div class=\"line\">        <span class=\"comment\">//Padding</span></div><div class=\"line\">        $block = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);</div><div class=\"line\">        $pad = $block - (strlen($encryptStr) % $block); <span class=\"comment\">//Compute how many characters need to pad</span></div><div class=\"line\">        $encryptStr .= str_repeat(chr($pad), $pad); <span class=\"comment\">// After pad, the str length must be equal to block or its integer multiples</span></div><div class=\"line\">        <span class=\"comment\">//encrypt</span></div><div class=\"line\">        $encrypted = mcrypt_generic($module, $encryptStr);</div><div class=\"line\">        mcrypt_generic_deinit($module);</div><div class=\"line\">        mcrypt_module_close($module);</div><div class=\"line\">        <span class=\"keyword\">return</span> base64_encode($encrypted);</div><div class=\"line\">    &#125;</div><div class=\"line\">     <span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptStr 需要解密的字符串</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptKey 加密时使用的key</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $iv 加密时使用的向量</span></div><div class=\"line\"><span class=\"comment\">    */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decrypt</span><span class=\"params\">($encryptStr,$encryptKey,$iv)</span> </span>&#123;</div><div class=\"line\">        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class=\"string\">''</span>, MCRYPT_MODE_CBC, $iv);</div><div class=\"line\">        mcrypt_generic_init($module, $encryptKey, $iv);</div><div class=\"line\">        $encryptedData = base64_decode($encryptStr);</div><div class=\"line\">        $encryptedData = mdecrypt_generic($module, $encryptedData);</div><div class=\"line\">        <span class=\"keyword\">return</span> $encryptedData;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"4、curlPost函数\"><a href=\"#4、curlPost函数\" class=\"headerlink\" title=\"4、curlPost函数\"></a>4、curlPost函数</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_curlPost</span><span class=\"params\">($url, $curlPost, $cookie_str = <span class=\"string\">''</span>, $header_ary = array<span class=\"params\">()</span>)</span></span>&#123;</div><div class=\"line\">    $curl = curl_init();</div><div class=\"line\">    curl_setopt($curl, CURLOPT_URL, $url);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_HEADER, <span class=\"keyword\">false</span>);</div><div class=\"line\">\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class=\"keyword\">true</span>);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_POST, <span class=\"keyword\">true</span>);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost);</div><div class=\"line\">\t<span class=\"keyword\">if</span> (substr($url,<span class=\"number\">0</span>,<span class=\"number\">5</span>)==<span class=\"string\">'https'</span>) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, <span class=\"keyword\">false</span>);</div><div class=\"line\">        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, <span class=\"keyword\">false</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> ($cookie_str) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_COOKIE, $cookie_str);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> ($header_ary) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_HTTPHEADER, $header_ary);</div><div class=\"line\">    &#125;</div><div class=\"line\">    $return_str = curl_exec($curl);</div><div class=\"line\">    curl_close($curl);</div><div class=\"line\">    <span class=\"keyword\">return</span> $return_str;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"5、请求数据\"><a href=\"#5、请求数据\" class=\"headerlink\" title=\"5、请求数据\"></a>5、请求数据</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//http://music.163.com/#/song?id=32507038</span></div><div class=\"line\">get_comment(<span class=\"number\">32507038</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">* 获取评论信息</span></div><div class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> $song_id 歌曲id</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_comment</span><span class=\"params\">($song_id)</span></span>&#123;</div><div class=\"line\">    $offset = <span class=\"number\">0</span>;</div><div class=\"line\">    $has_more = <span class=\"keyword\">true</span>;</div><div class=\"line\">    <span class=\"keyword\">while</span> ($has_more) &#123;</div><div class=\"line\">        $has_more = <span class=\"keyword\">false</span>;</div><div class=\"line\">        <span class=\"keyword\">list</span>($url, $data) = crypt_api($song_id, $offset);</div><div class=\"line\">        $headers = <span class=\"keyword\">array</span>(</div><div class=\"line\">            <span class=\"string\">'Referer'</span>=&gt;<span class=\"string\">'http://music.163.com/'</span>,</div><div class=\"line\">            <span class=\"string\">'Cookie'</span>=&gt; <span class=\"string\">'appver=1.5.0.75771;MUSIC_U=e954e2600e0c1ecfadbd06b365a3950f2fbcf4e9ffcf7e2733a8dda4202263671b4513c5c9ddb66f1b44c7a29488a6fff4ade6dff45127b3e9fc49f25c8de500d8f960110ee0022abf122d59fa1ed6a2;'</span></div><div class=\"line\">            );</div><div class=\"line\">        $result = _curlPost($url,http_build_query($data),<span class=\"string\">''</span>,$headers);</div><div class=\"line\">        <span class=\"keyword\">if</span> ($result) &#123;</div><div class=\"line\">            $data = json_decode($result);</div><div class=\"line\">            <span class=\"keyword\">if</span> ($data) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> ($data-&gt;code == <span class=\"number\">200</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> ($data-&gt;comments) &#123;</div><div class=\"line\">                        $comments = json_decode(json_encode($data-&gt;comments),<span class=\"keyword\">true</span>);</div><div class=\"line\">                        <span class=\"comment\">//保存评论信息</span></div><div class=\"line\">                        save_comments($song_id,$comments);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    $has_more = $data-&gt;more == <span class=\"string\">'true'</span>;</div><div class=\"line\">                    <span class=\"comment\">//跟get_params里面的limit参数一致</span></div><div class=\"line\">                    $offset += <span class=\"number\">20</span>;</div><div class=\"line\">                &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">                    handleError(<span class=\"string\">\"data['code']:$data[code]\"</span>);\t</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">                handleError(<span class=\"string\">\"json_decode error\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">            handleError(<span class=\"string\">\"_curlPost result:null\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sleep(<span class=\"number\">1</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>参考:</p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/ygyg/p/5686258.html\" target=\"_blank\" rel=\"noopener\">php实现AES/CBC/PKCS5Padding加密解密（又叫：对称加密）</a></li>\n<li><a href=\"https://github.com/wenhaoliang/netease-music-spider\" target=\"_blank\" rel=\"noopener\">https://github.com/wenhaoliang/netease-music-spider</a></li>\n<li><a href=\"http://blog.csdn.net/Ciiiiiing/article/details/62434438\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/Ciiiiiing/article/details/62434438</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"网易云音乐爬虫-爬取评论-PHP\"><a href=\"#网易云音乐爬虫-爬取评论-PHP\" class=\"headerlink\" title=\"网易云音乐爬虫 - 爬取评论 - PHP\"></a>网易云音乐爬虫 - 爬取评论 - PHP</h1><h4 id=\"1、拼接url\"><a href=\"#1、拼接url\" class=\"headerlink\" title=\"1、拼接url\"></a>1、拼接url</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">* 生成接口url</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">crypt_api</span><span class=\"params\">($song_id, $offset)</span></span>&#123;</div><div class=\"line\">    $url = <span class=\"string\">\"http://music.163.com/weapi/v1/resource/comments/R_SO_4_&#123;$song_id&#125;/?csrf_token=\"</span>;</div><div class=\"line\">    $first_param = <span class=\"string\">\"&#123;rid:\\\"\\\", offset:\\\"&#123;$offset&#125;\\\", total:\\\"true\\\", limit:\\\"20\\\", csrf_token:\\\"\\\"&#125;\"</span>; </div><div class=\"line\">    $forth_param = <span class=\"string\">\"0CoJUm6Qyw8W8jud\"</span>;</div><div class=\"line\">    $params = get_params($first_param, $forth_param);</div><div class=\"line\">    $encSecKey = get_encSecKey();</div><div class=\"line\">    $data = <span class=\"keyword\">array</span>(</div><div class=\"line\">        <span class=\"string\">\"params\"</span>=&gt; $params,</div><div class=\"line\">        <span class=\"string\">\"encSecKey\"</span>=&gt; $encSecKey</div><div class=\"line\">    );</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">array</span>($url, $data);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"2、生成接口的params参数\"><a href=\"#2、生成接口的params参数\" class=\"headerlink\" title=\"2、生成接口的params参数\"></a>2、生成接口的params参数</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/*</span></div><div class=\"line\"><span class=\"comment\">* 生成接口参数</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_params</span><span class=\"params\">($first_param, $forth_param)</span></span>&#123;</div><div class=\"line\">    $iv = <span class=\"string\">\"0102030405060708\"</span>;</div><div class=\"line\">    $first_key = $forth_param;</div><div class=\"line\">    $second_key = <span class=\"string\">'FFFFFFFFFFFFFFFF'</span>;</div><div class=\"line\">    $encryptObj = <span class=\"keyword\">new</span> MagicCrypt();</div><div class=\"line\">    $h_encText = $encryptObj-&gt;encrypt($first_param,$first_key,$iv);</div><div class=\"line\">\t$h_encText = $encryptObj-&gt;encrypt($h_encText,$second_key,$iv);</div><div class=\"line\">    <span class=\"keyword\">return</span> $h_encText;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_encSecKey</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    $encSecKey = <span class=\"string\">\"257348aecb5e556c066de214e531faadd1c55d814f9be95fd06d6bff9f4c7a41f831f6394d5a3fd2e3881736d94a02ca919d952872e7d0a50ebfa1769a7a62d512f5f1ca21aec60bc3819a9c3ffca5eca9a0dba6d6f7249b06f5965ecfff3695b54e1c28f3f624750ed39e7de08fc8493242e26dbc4484a01c76f739e135637c\"</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> $encSecKey;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3、AES-加密解密\"><a href=\"#3、AES-加密解密\" class=\"headerlink\" title=\"3、AES 加密解密\"></a>3、AES 加密解密</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MagicCrypt</span> </span>&#123;</div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptStr 需要加密的字符串</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptKey 加密的key</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $iv 向量，增加加密的安全性</span></div><div class=\"line\"><span class=\"comment\">    */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encrypt</span><span class=\"params\">($encryptStr,$encryptKey,$iv)</span> </span>&#123;</div><div class=\"line\">        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class=\"string\">''</span>, MCRYPT_MODE_CBC, $iv);</div><div class=\"line\">        mcrypt_generic_init($module, $encryptKey, $iv);</div><div class=\"line\">        <span class=\"comment\">//Padding</span></div><div class=\"line\">        $block = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, MCRYPT_MODE_CBC);</div><div class=\"line\">        $pad = $block - (strlen($encryptStr) % $block); <span class=\"comment\">//Compute how many characters need to pad</span></div><div class=\"line\">        $encryptStr .= str_repeat(chr($pad), $pad); <span class=\"comment\">// After pad, the str length must be equal to block or its integer multiples</span></div><div class=\"line\">        <span class=\"comment\">//encrypt</span></div><div class=\"line\">        $encrypted = mcrypt_generic($module, $encryptStr);</div><div class=\"line\">        mcrypt_generic_deinit($module);</div><div class=\"line\">        mcrypt_module_close($module);</div><div class=\"line\">        <span class=\"keyword\">return</span> base64_encode($encrypted);</div><div class=\"line\">    &#125;</div><div class=\"line\">     <span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptStr 需要解密的字符串</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $encryptKey 加密时使用的key</span></div><div class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> $iv 加密时使用的向量</span></div><div class=\"line\"><span class=\"comment\">    */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decrypt</span><span class=\"params\">($encryptStr,$encryptKey,$iv)</span> </span>&#123;</div><div class=\"line\">        $module = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class=\"string\">''</span>, MCRYPT_MODE_CBC, $iv);</div><div class=\"line\">        mcrypt_generic_init($module, $encryptKey, $iv);</div><div class=\"line\">        $encryptedData = base64_decode($encryptStr);</div><div class=\"line\">        $encryptedData = mdecrypt_generic($module, $encryptedData);</div><div class=\"line\">        <span class=\"keyword\">return</span> $encryptedData;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"4、curlPost函数\"><a href=\"#4、curlPost函数\" class=\"headerlink\" title=\"4、curlPost函数\"></a>4、curlPost函数</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_curlPost</span><span class=\"params\">($url, $curlPost, $cookie_str = <span class=\"string\">''</span>, $header_ary = array<span class=\"params\">()</span>)</span></span>&#123;</div><div class=\"line\">    $curl = curl_init();</div><div class=\"line\">    curl_setopt($curl, CURLOPT_URL, $url);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_HEADER, <span class=\"keyword\">false</span>);</div><div class=\"line\">\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class=\"keyword\">true</span>);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_POST, <span class=\"keyword\">true</span>);</div><div class=\"line\">    curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost);</div><div class=\"line\">\t<span class=\"keyword\">if</span> (substr($url,<span class=\"number\">0</span>,<span class=\"number\">5</span>)==<span class=\"string\">'https'</span>) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, <span class=\"keyword\">false</span>);</div><div class=\"line\">        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, <span class=\"keyword\">false</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> ($cookie_str) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_COOKIE, $cookie_str);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> ($header_ary) &#123;</div><div class=\"line\">        curl_setopt($curl, CURLOPT_HTTPHEADER, $header_ary);</div><div class=\"line\">    &#125;</div><div class=\"line\">    $return_str = curl_exec($curl);</div><div class=\"line\">    curl_close($curl);</div><div class=\"line\">    <span class=\"keyword\">return</span> $return_str;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"5、请求数据\"><a href=\"#5、请求数据\" class=\"headerlink\" title=\"5、请求数据\"></a>5、请求数据</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//http://music.163.com/#/song?id=32507038</span></div><div class=\"line\">get_comment(<span class=\"number\">32507038</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"><span class=\"comment\">* 获取评论信息</span></div><div class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> $song_id 歌曲id</span></div><div class=\"line\"><span class=\"comment\">*/</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_comment</span><span class=\"params\">($song_id)</span></span>&#123;</div><div class=\"line\">    $offset = <span class=\"number\">0</span>;</div><div class=\"line\">    $has_more = <span class=\"keyword\">true</span>;</div><div class=\"line\">    <span class=\"keyword\">while</span> ($has_more) &#123;</div><div class=\"line\">        $has_more = <span class=\"keyword\">false</span>;</div><div class=\"line\">        <span class=\"keyword\">list</span>($url, $data) = crypt_api($song_id, $offset);</div><div class=\"line\">        $headers = <span class=\"keyword\">array</span>(</div><div class=\"line\">            <span class=\"string\">'Referer'</span>=&gt;<span class=\"string\">'http://music.163.com/'</span>,</div><div class=\"line\">            <span class=\"string\">'Cookie'</span>=&gt; <span class=\"string\">'appver=1.5.0.75771;MUSIC_U=e954e2600e0c1ecfadbd06b365a3950f2fbcf4e9ffcf7e2733a8dda4202263671b4513c5c9ddb66f1b44c7a29488a6fff4ade6dff45127b3e9fc49f25c8de500d8f960110ee0022abf122d59fa1ed6a2;'</span></div><div class=\"line\">            );</div><div class=\"line\">        $result = _curlPost($url,http_build_query($data),<span class=\"string\">''</span>,$headers);</div><div class=\"line\">        <span class=\"keyword\">if</span> ($result) &#123;</div><div class=\"line\">            $data = json_decode($result);</div><div class=\"line\">            <span class=\"keyword\">if</span> ($data) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> ($data-&gt;code == <span class=\"number\">200</span>) &#123;</div><div class=\"line\">                    <span class=\"keyword\">if</span> ($data-&gt;comments) &#123;</div><div class=\"line\">                        $comments = json_decode(json_encode($data-&gt;comments),<span class=\"keyword\">true</span>);</div><div class=\"line\">                        <span class=\"comment\">//保存评论信息</span></div><div class=\"line\">                        save_comments($song_id,$comments);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                    $has_more = $data-&gt;more == <span class=\"string\">'true'</span>;</div><div class=\"line\">                    <span class=\"comment\">//跟get_params里面的limit参数一致</span></div><div class=\"line\">                    $offset += <span class=\"number\">20</span>;</div><div class=\"line\">                &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">                    handleError(<span class=\"string\">\"data['code']:$data[code]\"</span>);\t</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">                handleError(<span class=\"string\">\"json_decode error\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">            handleError(<span class=\"string\">\"_curlPost result:null\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        sleep(<span class=\"number\">1</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>参考:</p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/ygyg/p/5686258.html\" target=\"_blank\" rel=\"noopener\">php实现AES/CBC/PKCS5Padding加密解密（又叫：对称加密）</a></li>\n<li><a href=\"https://github.com/wenhaoliang/netease-music-spider\" target=\"_blank\" rel=\"noopener\">https://github.com/wenhaoliang/netease-music-spider</a></li>\n<li><a href=\"http://blog.csdn.net/Ciiiiiing/article/details/62434438\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/Ciiiiiing/article/details/62434438</a></li>\n</ol>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cjejamqyx0008wctxfpmlkek9","category_id":"cjejamqyt0004wctxdhh2dt2f","_id":"cjejamqz1000bwctx81170mjr"},{"post_id":"cjejamqyl0001wctxdyqiqa21","category_id":"cjejamqyt0004wctxdhh2dt2f","_id":"cjejamqz2000ewctx2bgv7xkx"},{"post_id":"cjejamqyq0003wctxya7bfi2a","category_id":"cjejamqyt0004wctxdhh2dt2f","_id":"cjejamqz3000fwctxo1gltewj"},{"post_id":"cjejamqyw0007wctxyjs6dmgd","category_id":"cjejamqyt0004wctxdhh2dt2f","_id":"cjejamqz4000hwctx8bc7njz1"}],"PostTag":[{"post_id":"cjejamqyl0001wctxdyqiqa21","tag_id":"cjejamqyv0005wctxdvzjk6d8","_id":"cjejamqz5000jwctxzfg1lp0h"},{"post_id":"cjejamqyl0001wctxdyqiqa21","tag_id":"cjejamqyz000awctxtedars7p","_id":"cjejamqz5000kwctxaw4w83pv"},{"post_id":"cjejamqyl0001wctxdyqiqa21","tag_id":"cjejamqz1000dwctxii1xr7wd","_id":"cjejamqz6000mwctxufuf6xws"},{"post_id":"cjejamqyl0001wctxdyqiqa21","tag_id":"cjejamqz3000gwctxnkajn4b1","_id":"cjejamqz6000nwctx0j3qugoj"},{"post_id":"cjejamqyq0003wctxya7bfi2a","tag_id":"cjejamqz4000iwctxkajo6szq","_id":"cjejamqz7000pwctx2jda5ntl"},{"post_id":"cjejamqyw0007wctxyjs6dmgd","tag_id":"cjejamqz6000lwctxxp7ac4qe","_id":"cjejamqz7000qwctxtoqe7chn"},{"post_id":"cjejamqyx0008wctxfpmlkek9","tag_id":"cjejamqz7000owctxgbph7h8d","_id":"cjejamqz9000swctxccte1qu6"},{"post_id":"cjejamqyx0008wctxfpmlkek9","tag_id":"cjejamqz6000lwctxxp7ac4qe","_id":"cjejamqza000twctxm344my9g"}],"Tag":[{"name":"Fuck GFW","_id":"cjejamqyv0005wctxdvzjk6d8"},{"name":"shadowsocks","_id":"cjejamqyz000awctxtedars7p"},{"name":"openwrt","_id":"cjejamqz1000dwctxii1xr7wd"},{"name":"pandorabox","_id":"cjejamqz3000gwctxnkajn4b1"},{"name":"Gitlab","_id":"cjejamqz4000iwctxkajo6szq"},{"name":"php","_id":"cjejamqz6000lwctxxp7ac4qe"},{"name":"netease","_id":"cjejamqz7000owctxgbph7h8d"}]}}